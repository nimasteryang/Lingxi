## Description

File upload component in Apache Struts 2 versions 2.0.0 through 2.3.37, 2.5.0 through 2.5.32, and 6.0.0 through 6.3.0 is vulnerable due to inadequate input validation [[7]](#References) . This vulnerability allows an attacker to execute arbitrary code via remote code execution (RCE) by manipulating file upload parameters to perform path traversal [[3]](#References) . Successful exploitation can result in the uploading of a malicious file, compromising systems that utilize vulnerable Struts implementations [[1]](#References) . Users are advised to upgrade to versions 2.5.33 or 6.3.0.2 or greater to mitigate this risk [[5]](#References) .

## Detailed Description

CVE-2023-50164 is a critical vulnerability found in the Apache Struts 2 framework, which is widely used for developing Java EE web applications [[3]](#References) . This vulnerability is characterized as a remote code execution (RCE) flaw that results from improper handling of file uploads and allows for path traversal attacks [[6]](#References) . Specifically, attackers can exploit this by manipulating file upload parameters, potentially enabling them to upload malicious files to the server [[5]](#References) [[9]](#References) . The affected versions include Apache Struts from 2.0.0 to 2.3.37, 2.5.0 to 2.5.32, and 6.0.0 to 6.3.0 [[6]](#References) [[3]](#References) [[9]](#References) . Given its severe nature, the vulnerability poses substantial risks, including unauthorized access, data manipulation, and lateral movement within networks [[9]](#References) . The exploitation could result in various impacts depending on the privileges of the web server process or the application's user configuration [[2]](#References) [[9]](#References) . Patches addressing CVE-2023-50164 have been released in versions 2.5.33 and 6.3.0.2 or later [[10]](#References) [[2]](#References) . Users are strongly encouraged to upgrade to these versions to mitigate the risks [[3]](#References) . While there are currently no verifiable reports of active exploitation, the potential for abuse remains, and the existence of public proof-of-concept (PoC) exploit code raises concerns for significant threats if the flaw is not remediated [[9]](#References) [[10]](#References) . In addition to upgrading, it is recommended to implement strict file type validations and size restrictions to further mitigate the vulnerability [[3]](#References) .

## Affected Versions

- Apache Struts 2: Affected Versions: 2.0.0 to 2.3.37, 2.5.0 to 2.5.32, 6.0.0 to 6.3.0.1 [[7]](#References) [[6]](#References) [[3]](#References) [[1]](#References) [[4]](#References) .


## Unaffected Versions

- Unaffected Versions of Apache Struts 2:
  - 2.5.33 and greater [[7]](#References) 
  - 6.3.0.1 and greater [[1]](#References) 
  - 6.3.0.2 or greater [[4]](#References) 
  - 2.3.38 and higher [[3]](#References) 

- Unaffected packages:
  - Apache Struts 2.5.33 [[6]](#References) 
  - Apache Struts 6.3.0.2 [[7]](#References) 

## Mitigation

1. Patch Management: Upgrade to Apache Struts version 2.5.33 or later, or version 6.3.0.2 or later to remediate the vulnerability [[7]](#References) . This is a straightforward procedure that should be applied as soon as possible to prevent potential remote code execution risks [[3]](#References) .

   Implementation Steps:
   - Identify the location where Apache Struts is installed in your application.
   - Backup your existing Apache Struts setup.
   - Download the latest version from the official Apache Struts website:
     
```bash
     wget https://downloads.apache.org/struts/2.5.33/struts-2.5.33-distribution.zip
```
   - Unzip the downloaded file and replace the existing Struts libraries in your web application with the updated ones:
     
```bash
     unzip struts-2.5.33-distribution.zip
     cp -r struts-2.5.33/lib/* /path/to/your/webapp/WEB-INF/lib/
```
   - Restart the web application server.

2. Input Validation and Whitelisting: Implement strict input validation and whitelisting for file upload parameters to prevent malicious input that could exploit this vulnerability [[5]](#References) . 

   Implementation Steps:
   - Modify the file upload logic in your application to validate the file path and type strictly. Ensure that only acceptable file types are processed, and no unauthorized paths are accepted.
   - Use a regex or a list of allowed file types/paths, for example:
     
```java
     public void uploadFile(HttpServletRequest request) {
         String filePath = request.getParameter("filePath");
         // Only allow specific paths and file types
         if (!filePath.matches("^[a-zA-Z0-9-_]+\.txt$") ) {
             throw new IllegalArgumentException("Invalid file type or path.");
         }
         ...
     }
```

3. Web Application Firewall (WAF): Deploy a WAF to monitor and filter HTTP requests. Configure it to look for patterns indicative of path traversal attacks and block any relevant attempts [[6]](#References) .

   Implementation Steps:
   - Choose a WAF solution compatible with your environment (e.g., ModSecurity, AWS WAF).
   - Set up the WAF following the vendor's documentation. For example, with ModSecurity, you can enable rules specific to file upload validation:
     
```bash
     ' Example ModSecurity configuration
     SecRule REQUEST_URI "@contains /upload" "id:1001,phase:2,deny,status:403"
```

## Exploit

To exploit CVE-2023-50164, an attacker typically follows these steps:

1. Identify Vulnerable Software: Target instances of Apache Struts 2 with versions between 2.0.0 to 2.5.32 and 6.0.0 to 6.3.0. Verify permissions and configurations that allow file uploads [[3]](#References) .

2. Manipulate File Upload Parameters: Use crafted requests to manipulate file upload parameters. This often involves altering the paths in the upload requests to facilitate path traversal [[5]](#References) [[6]](#References) .

3. Trigger Path Traversal: Exploit the path traversal flaw to navigate outside the designated file upload directories, enabling access to restrictive file systems [[7]](#References) [[4]](#References) .

4. Upload Malicious File: Under successful manipulation, upload a malicious file to the server. This file may contain arbitrary code that the attacker intends to execute [[5]](#References) [[9]](#References) .

5. Execute Code Remotely: Once the malicious file is uploaded, execute the code within it on the server, potentially gaining control over the application with the permissions of the web server or specific application users [[6]](#References) [[3]](#References) .

6. Escalate Impact: Utilize the access gained from the remote code execution to conduct further malicious activities, such as data theft, modification of sensitive files, or lateral movement within the network [[3]](#References) [[10]](#References) .

Mitigation steps include patching vulnerable versions to at least 2.5.33 or 6.3.0.2, implementing strict file type restrictions, and limiting uploaded file sizes [[4]](#References) .

## Root Cause

The root cause of the vulnerability (CVE-2023-50164) in Apache Struts 2 can be attributed to inadequate input validation in the `HttpParameters` class, which facilitates the handling of HTTP parameters in a web application [[7]](#References) . Specifically, the vulnerability arises from improper handling of input parameters that can lead to path traversal and remote code execution when the application processes file uploads [[9]](#References) .  "' Part 1: Lack of Case Sensitivity in Parameter Handling  In the original implementation of `HttpParameters`, parameters were handled in a case-sensitive manner [[7]](#References) . This was problematic because an attacker could create multiple parameters that differ only in case (e.g., `File` vs. `file`), leading to ambiguity in parameter handling and potential code execution through path traversal [[4]](#References) . The following code snippet illustrates this issue: 
```java public boolean contains(String name) { return parameters.containsKey(name); } ``` This method checks for the existence of the parameter using the exact case provided. This lack of case insensitivity means that parameter names such as `Upload` and `upload` would be treated as distinct entities, allowing an attacker to bypass security checks by utilizing different casing in input parameters [[7]](#References) . The ability to manipulate parameter names can severely impact the security of file uploads, leading to unauthorized access or code execution.  "' Part 2: Inadequate Parameter Rejection Mechanism  The parameter rejection mechanism also failed to scrutinize the validity of parameter names adequately when removing or checking parameters [[7]](#References) . This is showcased in the following snippet: 
```java public HttpParameters remove(Set<String> paramsToRemove) { for (String paramName : paramsToRemove) { parameters.remove(paramName); } return this; } ``` In this method, parameters are removed based on their exact names [[7]](#References) . An attacker could leverage this behavior by injecting malicious file paths that include dots or slashes, effectively bypassing checks that are only applied to well-formed parameters [[6]](#References) . The absence of a robust validation mechanism for input parameters not only allows potential unauthorized actions but also introduces risks related to file integrity and system security.  "' Part 3: Lack of Normalization of Parameter Values  Another facet of the vulnerability stems from the handling of parameter values without normalization, which affects how requests are processed by the server [[3]](#References) . The following segment demonstrates the lack of normalization in the method responsible for retrieving parameters: 
```java @Override public Parameter get(Object key) { if (parameters.containsKey(key)) { return parameters.get(key); } else { return new Parameter.Empty(String.valueOf(key)); } } ``` This piece of code allows retrieval of parameters based solely on exact matching of keys [[7]](#References) . The lack of normalization means that any variations in the incoming key due to encoding or peculiar characters could lead to unexpected behavior; malicious actors could exploit this to gain unintended access, given that the checks for valid parameter names and values were insufficient [[4]](#References) . This vulnerability can lead to scenarios where unauthorized files are uploaded or executed with elevated privileges.  "' Summary of Interconnections  These three components—case sensitivity, inadequate rejection mechanisms, and a lack of normalization—interrelate to create a larger vulnerability within the `HttpParameters` handling [[9]](#References) . The key contributions to the root cause stem from the inadequate validation of user input, exacerbated by the design choices that favored ease of use over robust security measures. The collective impact of these issues creates an environment ripe for exploitation, allowing attackers to exploit the file upload functionality maliciously.

## References

- [1]  https://seclists.org/oss-sec/2023/q4/263
- [2]  https://blog.qualys.com/product-tech/2024/02/07/announcing-totalcloud-2-0-with-trurisk-insights-the-future-of-cloud-and-saas-security
- [3]  https://www.bleepingcomputer.com/news/security/hackers-are-exploiting-critical-apache-struts-flaw-using-public-poc/
- [4]  https://thehackernews.com/2023/12/new-critical-rce-vulnerability.html
- [5]  https://go.theregister.com/feed/www.theregister.com/2023/12/13/december_2023_patch_tuesday/
- [6]  https://www.infosecurity-magazine.com/news/apache-warns-critical/
- [7]  https://www.securityweek.com/apache-patches-critical-rce-vulnerability-in-struts-2/
- [8]  https://gbhackers.com/sap-security-patch-code-injection-alert/
- [9]  https://securityaffairs.com/155643/hacking/apache-struts-2-critical-flaw.html
- [10]  https://www.heise.de/news/SAP-schliesst-zehn-Sicherheitsluecken-am-Maerz-Patchday-9652057.html?wt_mc=rss.red.security.security.atom.beitrag.beitrag

