## 漏洞描述

Apache HttpClient in The Apache Software Foundation versions 4.5.12 and prior, and 5.0.2 and prior, suffers from incorrect handling of malformed URI authority components [[3]](#引用) . This vulnerability allows an unauthenticated remote attacker to manipulate request execution by sending crafted request URIs that direct requests to unintended hosts [[5]](#引用) . The issue arises from insufficient validation of user-supplied input within the java.net.URI objects [[5]](#引用) . To mitigate this vulnerability, users are advised to upgrade to versions 4.5.13 or 5.0.3, which include fixes that reject such malformed authority components as invalid [[3]](#引用) [[1]](#引用) .

## 详细描述

CVE-2020-13956 affects the Apache HttpClient library, specifically versions 4.5.12 and earlier as well as 5.0.2 and earlier [[3]](#引用) . This vulnerability stems from inadequate validation of user-provided input, particularly concerning the authority components of request URIs [[5]](#引用) . When malformed URIs are passed as java.net.URI objects, the library can misinterpret these components, leading to the selection of incorrect target hosts for executing requests [[6]](#引用) . This misinterpretation could be exploited by remote, unauthenticated attackers, potentially allowing them to manipulate how requests are processed and target unintended hosts [[1]](#引用) . The issue was identified and reported by researcher Priyank Nigam [[6]](#引用) . However, this vulnerability has been mitigated in subsequent releases, specifically versions 4.5.13 and 5.0.3, where the library now rejects ambiguous malformed authority components as invalid [[3]](#引用) . Users are strongly advised to upgrade to these patched versions and to sanitize request URIs adequately when using java.net.URI as input to minimize the risk associated with this vulnerability [[3]](#引用) .

## 排查步骤(生成式)

- Check for Apache HttpClient: Verify if your application utilizes the Apache HttpClient library. This establishes the base for vulnerability assessment.
  - Command: `mvn dependency:list | grep httpclient`
  
  - Description: Confirming the presence of Apache HttpClient is essential as it’s pivotal to further evaluating if the installed version is vulnerable.

- Review Affected Versions: If Apache HttpClient is confirmed, check the installed version against the known vulnerable versions (4.5.12 and prior, 5.0.2 and prior). 
  - Command: `mvn dependency:list | grep httpclient | awk '{print $2}' | cut -d':' -f2`
  
  - Description: This step is critical to establish whether the current version falls within the vulnerable range, which is necessary for potential exploitability.

- Monitor User Input Handling: Check if the application correctly validates user-supplied URIs before passing them to Apache HttpClient. This could involve code review or dynamic application testing.
  - Command: Review application code or logs where user-supplied URIs are processed.
  
  - Description: Ensuring that the application has appropriate input validation against malformed URIs is vital in mitigating potential exploit chances, even if the vulnerable version is in use. 

- Confirm Usage of Malformed URIs: Test if the application can be triggered to process a malformed URI through sample inputs, ideally in a controlled test environment.
  - Command: Manually craft and submit deliberately malformed URIs to the application, observing for unexpected behavior or misdirection.
  
  - Description: This enables verification that the application endpoint can be manipulated, which determines the ease of exploit and validates the vulnerability’s operational context.

## 受影响版本(生成式)

- Apache HttpClient:
  - Affected Versions: 4.5.12 and prior [[3]](#引用) 
  - Affected Versions: 5.0.2 and prior [[3]](#引用) 
- Apache HttpComponents:
  - Affected Versions: 4.0.x, 4.1.x, 4.2.x, 4.3.x, 4.4.x, 4.5.x through 4.5.12, 5.0, 5.0.1, 5.0.2 [[5]](#引用) 
- httpcomponents-client:
  - Affected Versions: All versions prior to 4.5.7-1+deb10u1 [[6]](#引用) 

## 不受影响版本(生成式)

- Component: Apache HttpClient  
  - Unaffected Versions: 4.5.13, 5.0.3 and later [[3]](#引用) [[1]](#引用) 

- Component: Apache HttpComponents  
  - Unaffected Versions: 4.5.13, 5.0.3 [[5]](#引用) 

- Component: httpcomponents-client  
  - Unaffected Versions: 4.5.7-1+deb10u1 and later [[6]](#引用) 

## 规避方案(生成式)

1. Patch Management: Upgrade to Apache HttpClient version 4.5.13 or 5.0.3 [[3]](#引用) . This straightforward step involves replacing the current library version with one that contains the security fix. To implement this, perform the following steps in your project:

   - If using Maven, update your `pom.xml` dependency:
     
```xml
     <dependency>
         <groupId>org.apache.httpcomponents</groupId>
         <artifactId>httpclient</artifactId>
         <version>4.5.13</version> <!-- or 5.0.3 -->
     </dependency>
```
   - If using Gradle, update your `build.gradle`:
     
```groovy
     implementation 'org.apache.httpcomponents:httpclient:4.5.13' // or 5.0.3
```
   - For manual installations, download the updated jar file from the [Apache HttpComponents releases page](https://hc.apache.org/downloads.cgi) and replace the existing library file in your project.

   This mitigation is effective as it ensures that the application uses a version of HttpClient that includes improved validation mechanisms to reject malformed URIs, addressing the core vulnerability directly.

2. Input Sanitization: Implement input validation to strictly check and sanitize all request URIs before they are passed to the Apache HttpClient. This can be done in the following manner:

   Use a utility method to validate and sanitize your URI input:
   
```java
   public URI sanitizeURI(String inputUri) throws URISyntaxException {
       // Use a regex to enforce valid URI patterns before parsing
       String sanitizedUri = inputUri.replaceAll("(?i)user:[^@]+@", ""); // Remove user info
       // Additional sanitization rules can be added here
       return new URI(sanitizedUri);
   }
```

   Call this method before constructing your HTTP request:
   
```java
   String inputUri = "http://user:password@host:invalid_port/path"; // example input
   URI sanitizedUri = sanitizeURI(inputUri);
   HttpGet request = new HttpGet(sanitizedUri);
```

   This mitigation is crucial as it preemptively ensures that only properly structured URIs are processed, minimizing the risk associated with untrusted or malformed input leading to potential exploitation.

## 受影响版本(总结式)

- Component: Apache HttpClient
    - Affected Versions: 4.5.12 and prior [[3]](#引用) 
    - Affected Versions: 5.0.2 and prior [[3]](#引用) 
- Component: Apache HttpComponents
    - Affected Versions: 4.0.x, 4.1.x, 4.2.x, 4.3.x, 4.4.x, 4.5.x-4.5.12, 5.0, 5.0.1, 5.0.2 [[5]](#引用) 
- Component: httpcomponents-client
    - Affected Versions: All versions prior to 4.5.7-1+deb10u1 [[6]](#引用) 

## 不受影响版本(总结式)
- - Component: Apache HttpClient'  '-- Unaffected Versions: 4.5.13 and 5.0.3 and later [[3]](#引用) [[1]](#引用) '  '-- Component: Apache HttpComponents'  '-- Unaffected Versions: 4.5.13, 5.0.3 [[5]](#引用) '  '-- Component: httpcomponents-client'  '-- Unaffected Versions: before version 4.5.7-1+deb10u1 [[6]](#引用) '

## 排查步骤(总结式)

- Check Installation: Verify that the Apache HttpClient package is installed on the system [[6]](#引用) .
- Check Program Version: Confirm that the version of Apache HttpClient is not earlier than 4.5.13 or 5.0.3 to ensure the vulnerability is patched [[3]](#引用) .
- Sanitize User Input: Ensure that any request URIs are sanitized, particularly when using java.net.URI to handle input, to prevent exploitation of malformed authority components [[1]](#引用) .
- Upgrade: If the installed version is found to be vulnerable, upgrade the Apache HttpClient to the appropriate patched version [[3]](#引用) .

## 规避方案(总结式)

- Upgrade to Apache HttpClient version 4.5.13 or 5.0.3 [[3]](#引用) .
- Sanitize request URIs when using java.net.URI as input [[3]](#引用) .
- Ensure the updated HttpClient rejects URIs with ambiguous malformed authority components as invalid [[3]](#引用) .
- For Debian systems, upgrade to version 4.5.7-1+deb10u1 of the httpcomponents-client package [[6]](#引用) .

## 利用分析

CVE-2020-13956 pertains to a vulnerability in Apache HttpClient versions prior to 4.5.13 and 5.0.3, where the library fails to correctly handle malformed URI authority components [[3]](#引用) . This flaw enables an attacker to craft a malicious URI that, when processed as a 'java.net.URI' object, causes the library to misidentify the target host for the request execution [[1]](#引用) .

To exploit this vulnerability, an attacker would execute the following steps:

1. Craft a Malformed URI: The attacker constructs a URI with an ambiguous or malformed authority component designed to confuse the HttpClient's parsing logic [[3]](#引用) .
   
2. Submit the URI: This crafted URI is passed to an application that utilizes an affected version of Apache HttpClient (4.5.12 or earlier, 5.0.2 or earlier) [[6]](#引用) .

3. Leverage Misinterpretation: When the application processes the malformed URI, it selects an unintended target host due to the misinterpretation, potentially allowing the attacker to direct traffic or execute requests at this unintended host [[5]](#引用) .

4. Execute Attacks: Depending on the context, the attacker could exploit this misdirection for unauthorized access, data manipulation, or other malicious actions against the misidentified target [[1]](#引用) .

Mitigation is achieved by updating to versions 4.5.13 or 5.0.3, where the library enhances its validation mechanisms to reject ambiguous malformed URIs outright [[3]](#引用) .

## 根因分析

The root cause of the vulnerability CVE-2020-13956 in the Apache HttpClient lies in the improper handling of malformed URI authority components within the 'URIUtils' class, specifically in the 'extractHost' method [[3]](#引用) . The code fails to validate user-supplied input thoroughly before constructing the 'HttpHost' object, which can allow attackers to craft specially formatted URIs that direct requests to unintended hosts [[5]](#引用) .

 Part 1: Lack of Validation for Host Extraction

The first part of the root cause is the lack of validation for the host and port extraction logic. The vulnerable code in the 'extractHost' method shows an inadequate check on the authority component of the URI [[3]](#引用) :


```java
public static HttpHost extractHost(final URI uri) {
    if (uri == null) {
        return null;
    }
    HttpHost target = null;
    if (uri.isAbsolute()) {
        int port = uri.getPort(); // may be overridden later
        String host = uri.getHost();
        if (host == null) { // normal parse failed; let's do it ourselves
            // authority does not seem to care about the valid character-set for host names
            host = uri.getAuthority();
            if (host != null) {
```

This code does not sufficiently verify if the 'host' variable conforms to valid DNS hostname specifications before usage. An attacker can exploit this by crafting a URI with an invalid or malicious host, leading to potential request redirection [[6]](#引用) .

 Part 2: Incorrect Handling of User Credentials

A secondary issue contributing to the vulnerability is how the method handles user credentials included within the authority component [[5]](#引用) :


```java
int at = host.indexOf('@');
if (at >= 0) {
    if (host.length() > at + 1) {
        host = host.substring(at + 1);
    } else {
        host = null; // @ on its own
    }
}
```

The existing code incorrectly assumes that if user credentials are provided (e.g., 'user:pass@host'), the subsequent string must be the valid hostname. This simplistic parsing fails if the user input includes additional malformations, which can lead to parsing errors that produce unexpected results, allowing attackers to specify alternate hosts or ports [[6]](#引用) .

 Part 3: Unchecked Port Parsing

Another significant issue is the unregulated parsing of port numbers from the host string, which can lead to various inconsistencies:


```java
if (host != null) {
    final int colon = host.indexOf(':');
    if (colon >= 0) {
        int pos = colon + 1;
        int len = 0;
        for (int i = pos; i < host.length(); i++) {
            if (Character.isDigit(host.charAt(i))) {
                len++;
            } else {
                break;
            }
        }
        if (len > 0) {
            try {
                port = Integer.parseInt(host.substring(pos, pos + len));
            } catch (final NumberFormatException ex) {
            }
        }
        host = host.substring(0, colon);
    }
}
```

This section retrieves the port value without properly validating whether the extracted substring represents a legitimate port number. If an attacker provides arbitrary characters instead of numeric digits, this can lead to exceptions or undefined behavior. The resulting scenarios can potentially lead to denial of service or incorrect resolution of URIs [[3]](#引用) .

Together, these explanations reflect the main parts of the root cause leading to CVE-2020-13956, which centers on insufficient validation and parsing of user-supplied input when generating URI objects. This thorough understanding highlights the critical need for rigorous input validation in any code handling remote connections and user data.

## 修复解释

In the patch identified by commit ID e628b4c5c464c2fa346385596cc78e035a91a62e, changes were made to the `extractHost` method in the `URIUtils.java` file located in the path `httpclient/src/main/java/org/apache/http/client/utils/`. 

The patch addresses vulnerabilities related to the improper handling of malformed authority components in URIs, which can lead to incorrect host identification.

Here are the significant changes along with explanations:


```java
-        HttpHost target = null;
```
This line, which initialized the `target` variable, is removed to streamline the logic. 


```java
-            int port = uri.getPort(); // may be overridden later
-            String host = uri.getHost();
-            if (host == null) { // normal parse failed; let's do it ourselves
+            if (uri.getHost() == null) { // normal parse failed; let's do it ourselves
```
The conditional check was modified to eliminate the redundant retrieval of the host and port, directly focusing on the scenario where the host is `null`.


```java
-                host = uri.getAuthority();
+                if (uri.getAuthority() != null) {
+                    String content = uri.getAuthority();
```
Instead of re-parsing authority to extract the host later, the patch now directly utilizes the authority component when the host is not parsed correctly. 


```java
+                    int at = content.indexOf('@');
+                    if (at != -1) {
+                        content = content.substring(at + 1);
```
These lines are added to handle user credentials in the authority component. If credentials are present (the `@` character), they are stripped off before further processing the host and port, thereby mitigating the risk of assuming an incorrect host based on malformed input.


```java
+                    final String scheme = uri.getScheme();
+                    final String hostname;
+                    final int port;
+                    at = content.indexOf(":");
```
This introduces a robust mechanism for extracting the hostname and port. The changes ensure stricter control over the structure of the authority by clearly defining where the hostname ends and the port begins.


```java
+                    try {
+                        return new HttpHost(hostname, port, scheme);
+                    } catch (final IllegalArgumentException ex) {
+                        return null; 
```
This block safely attempts to create and return a new `HttpHost` object with the extracted hostname and port, ensuring that malformed port formats do not lead to misleading behavior. If creation fails due to invalid parameters, `null` is returned.


```java
-            } else {
-                return new HttpHost(uri.getHost(), uri.getPort(), uri.getScheme());
+            } else {
+                return new HttpHost(uri.getHost(), uri.getPort(), uri.getScheme());
```
The final conditional now returns a valid `HttpHost` if the host is successfully parsed, reinforcing the importance of structured authority handling.

These modifications collectively enhance the URI parsing robustness in the `extractHost` method, providing better validation against malformed authority components and addressing the vulnerability described in CVE-2020-13956.The patch for the code is at: https://api.github.com/repos/apache/httpcomponents-client/commits/e628b4c5c464c2fa346385596cc78e035a91a62e

## 引用

- [1]  Oleg Kalnichevski <olegk@apache.org>
- [2]  https://example.com
- [3]  http://seclists.org/oss-sec/2020/q4/34
- [4]  Oleg Kalnichevski <olegk@apache.org
- [5]  https://s.tencent.com/research/bsafe/1142.html
- [6]  https://www.debian.org/security/2020/dsa-4772

