## Description

CVE-2024-47685 is a vulnerability in the Linux kernel's netfilter subsystem, specifically within the `nf_reject_ipv6` functionality, prominently located in the `nf_reject_ip6_tcphdr_put()` function [[8]](#References). The issue involves the risk of transmitting uninitialized data through the four reserved TCP bits (th->res1), which can lead to unpredictable behavior in TCP connection handling [[4]](#References)[[8]](#References). This vulnerability was identified by syzbot and is classified as a use of uninitialized values, which poses a significant risk of generating erroneous TCP headers [[4]](#References). To mitigate the issue, the function was amended to apply `skb_put_zero()`, ensuring the entire TCP header is properly initialized before transmission, mirroring the existing safeguards present in the `nf_reject_ip_tcphdr_put()` function [[4]](#References)[[5]](#References). The problematic behavior was documented in specific memory access instances during operations within the networking stack, particularly related to functions such as `nf_send_reset6` and `nft_reject_inet_eval` [[1]](#References)[[8]](#References). The vulnerability is applicable to a variety of Linux kernel versions, notably from 3.18 through several release candidates prior to 6.11 [[1]](#References)[[8]](#References). The severity of CVE-2024-47685 is rated critical, with a CVSS score of 9.1, indicating high potential impacts on confidentiality and availability while having no direct impact on integrity [[5]](#References)[[6]](#References). The flaw allows for the remote exploitation of the system without requiring user interaction, thus presenting a significant security concern for affected systems [[3]](#References). The resolution is included in patches and updates to the Linux kernel, aimed at reinforcing network service integrity and stability [[7]](#References)[[8]](#References).

## Affected Versions

- Component: Linux Kernel
    - Affected Versions: 3.18 through 5.10.227 (inclusive) [[5]](#References)
    - Affected Versions: 4.19.16 through 4.19.310 (inclusive) [[8]](#References)
    - Affected Versions: 5.0.0 through 5.10.219 (inclusive) [[8]](#References)
    - Affected Versions: 5.11.0 through 5.11.9 (inclusive) [[8]](#References)
    - Affected Versions: 5.11 through 5.15.168 (inclusive) [[5]](#References)
    - Affected Versions: 5.16 through 6.1.113 (inclusive) [[5]](#References)
    - Affected Versions: 6.2 through 6.6.54 (inclusive) [[5]](#References)
    - Affected Versions: 6.7 through 6.10.13 (inclusive) [[5]](#References)
    - Affected Versions: 6.11 through 6.11.2 (inclusive) [[5]](#References)
    - Affected Versions: 5.10.223-1 (bullseye) [[2]](#References)
    - Affected Versions: 5.10.226-1 (bullseye security) [[2]](#References)
    - Affected Versions: 6.1.106-3 (bookworm) [[2]](#References)
    - Affected Versions: 6.1.112-1 (bookworm security) [[2]](#References)
    - Affected Versions: 5.4.x versions leading up to 5.4.276 (exclusive) [[8]](#References)
    - Affected Versions: All release candidates (rc) of each version from 4.19.0 to 5.11.x [[8]](#References)

## Unaffected Versions

- Component: Linux Kernel
    - Unaffected Versions:
        - 3.18.0 through 3.18.255 (inclusive) [[8]](#References)
        - 4.14.0 through 4.14.255 (inclusive) [[8]](#References)
        - 4.19.0 through 4.19.14 (inclusive) [[8]](#References)
        - 5.0 through 5.0.21 (inclusive) [[8]](#References)
        - 5.1 through 5.1.21 (inclusive) [[8]](#References)
        - 5.2 through 5.2.21 (inclusive) [[8]](#References)
        - 5.3 through 5.3.17 (inclusive) [[8]](#References)
        - 5.4 through 5.4.219 (inclusive) [[8]](#References)
        - 5.5 through 5.5.15 (inclusive) [[8]](#References)
        - 5.6 through 5.6.19 (inclusive) [[8]](#References)
        - 5.7 through 5.7.19 (inclusive) [[8]](#References)
        - 5.8 through 5.8.18 (inclusive) [[8]](#References)
        - 5.9 through 5.9.16 (inclusive) [[8]](#References)
        - 5.10.227 (and higher) [[1]](#References)
        - 5.15.168 (and higher) [[1]](#References)
        - 6.1.113 (and higher) [[1]](#References)
        - 6.6.54 (and higher) [[1]](#References)
        - 6.10.13 (and higher) [[1]](#References)
        - 6.11.2 (and higher) [[1]](#References)
        - 6.12-rc1 [[1]](#References)
        - 6.11.2-1 (for Debian:13) [[3]](#References)
        - 6.1.115-1 [[2]](#References)

## Mitigation

- Ensure that the function `nf_reject_ip6_tcphdr_put()` properly initializes the TCP header using `skb_put_zero()` to avoid sending garbage on reserved TCP bits [[8]](#References).
- Update to fixed versions of the Linux kernel:
    - Version 4.19.70 or later [[8]](#References).
    - For Debian bookworm, update to 6.1.115-1 or later [[2]](#References).
    - For Debian unstable (sid, trixie), update to 6.11.2-1 or later [[2]](#References).
- Apply patches from the Linux kernel stable tree [[1]](#References).
- Regularly apply security updates and patches to the Linux kernel [[8]](#References).
- Implement strong input validation and error handling mechanisms in network-related kernel functions [[8]](#References).
- Confirm that all systems are using a kernel version that addresses CVE-2024-47685, and regularly check for newer versions [[8]](#References).
- Open a support case if an immediate fix is required [[4]](#References).

## Exploit

CVE-2024-47685 is a vulnerability in the Linux kernelâ€™s netfilter module, specifically within the `nf_reject_ip6_tcphdr_put()` function, which improperly manages TCP header reserved bits [[8]](#References). Exploiting this vulnerability involves several precise steps:
1. Identify the Target Systems: The attacker must target vulnerable Linux kernel versions, particularly 6.11 and earlier, along with versions 4.19.x up to 5.10.226 [[1]](#References)[[8]](#References).
2. Establish Network Access: The attacker needs to be within the network of the target system to send crafted packets, as the exploit leverages a network-based attack vector [[5]](#References)[[8]](#References).
3. Craft Malicious IPv6 Packets: The attacker creates specifically formulated IPv6 packets that trigger the problematic behavior in the `nf_reject_ip6_tcphdr_put()` function. These packets should be designed to invoke the function improperly, ensuring that uninitialized memory is utilized, which can lead to the introduction of erroneous data in reserved TCP bits [[6]](#References)[[8]](#References).
4. Send Packets to the Target: By transmitting the specially crafted packets to the vulnerable system, the attacker pushes the system to process these malformed packets via the mentioned function, thereby encountering the flaw [[5]](#References)[[8]](#References).
5. Leverage the Exploit: Upon processing the packets that resulted in mishandled TCP header data, the attacker may exploit the ensuing uninitialized output to conduct further attacks. This could include information leakage, denial of service, or potentially remote code execution, depending on the system's configuration and security posture [[1]](#References)[[4]](#References)[[5]](#References). Mitigation strategies involve ensuring robust validation of incoming packets and updating to secure versions of the Linux kernel to prevent exploitation of this vulnerability [[4]](#References)[[6]](#References).

## Root Cause

The root cause of the vulnerability CVE-2024-47685 in the netfilter component of the Linux kernel primarily stems from the handling of uninitialized values in the `nf_reject_ip6_tcphdr_put()` function [[1]](#References)[[5]](#References)[[8]](#References). Specifically, there are two components contributing to the problem:

1. Missing Initialization of TCP Header Fields: Within the function, the TCP header is allocated space using `skb_put()`, but it does not initialize the memory to zero [[4]](#References)[[7]](#References)[[8]](#References). This means that any uninitialized fields within the TCP header may contain garbage values, potentially leading to unpredictable behavior when these values are subsequently processed or transmitted [[4]](#References). The relevant code snippet demonstrates this issue:
    ```c
    void nf_reject_ip6_tcphdr_put(struct sk_buff *nskb,
                                    const struct sk_buff *oldskb,
                                    const struct tcphdr *oth, unsigned int otcplen)
    {
        struct tcphdr *tcph;
        skb_reset_transport_header(nskb);
        tcph = skb_put(nskb, sizeof(struct tcphdr));
        ...
    }
    ```
   The lack of zero-initialization allows sensitive fields to carry over uninitialized values, affecting how packets are formed and potentially resulting in invalid TCP segments [[6]](#References).

2. Improper Handling of TCP Flags and Checksum: The follow-up logic that creates the TCP segment relies on the uninitialized fields [[1]](#References). For instance, flags such as `rst` and `ack` are set based on potentially garbage data. If the wrong flags or incorrect sequence numbers are transmitted, it could lead to denial-of-service conditions or unintended packet behaviors [[2]](#References). An excerpt from the vulnerable function illustrates this:
    ```c
   if (oth->ack) {
       tcph->seq = oth->ack_seq;
   } else {
       tcph->ack_seq = htonl(ntohl(oth->seq) + oth->syn + oth->fin + otcplen - (oth->doff << 2));
   }
   ...
   tcph->check = csum_ipv6_magic(&ipv6_hdr(nskb)->saddr,
                                  &ipv6_hdr(nskb)->daddr,
                                  sizeof(struct tcphdr), IPPROTO_TCP,
                                  csum_partial(tcph, sizeof(struct tcphdr), 0));
    ```
   The calculations here depend on correctly initialized fields to compute checksums and sequence numbers. When uninitialized values are included, it could lead to invalid TCP headers being sent, which would compromise network integrity and reliability [[3]](#References).

These two root causes collectively introduce the vulnerability, as they allow for the creation and transmission of improperly structured TCP packets that could result in system instability or security issues [[7]](#References).

## References

- [1] https://www.cvedetails.com/cve/CVE-2024-47685
- [2] https://security-tracker.debian.org/tracker/CVE-2024-47685
- [3] https://storage.googleapis.com/cve-osv-conversion/osv-output/CVE-2024-47685.json
- [4] https://access.redhat.com/security/cve/cve-2024-47685
- [5] https://vulners.com/cve/CVE-2024-47685
- [6] https://app.soos.io/research/vulnerabilities/CVE-2024-47685
- [7] https://nvd.nist.gov/vuln/detail/CVE-2024-47685
- [8] https://cve.circl.lu/cve/CVE-2024-47685

