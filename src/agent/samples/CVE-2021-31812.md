## 漏洞描述

Apache PDFBox in the Apache Software Foundation versions 2.0.23 and earlier is vulnerable to excessive iteration that leads to an infinite loop when processing a specially crafted PDF file [[8]](#引用) [[7]](#引用) [[10]](#引用) . This vulnerability allows an unauthenticated remote attacker to cause a denial of service (DoS) by making the application enter an infinite loading state [[8]](#引用) [[11]](#引用) . Exploitation can lead to significant consumption of CPU or memory resources, severely impacting system availability [[11]](#引用) . It is recommended that users upgrade to version 2.0.24 or higher to mitigate this risk [[8]](#引用) [[3]](#引用) [[1]](#引用) .

## 详细描述

CVE-2021-31812 is a vulnerability discovered in Apache PDFBox affecting versions 2.0.23 and earlier in the 2.0.x series [[8]](#引用) . The vulnerability arises from the library's handling of specially crafted PDF files, which can lead to an infinite loop during the file loading process [[8]](#引用) [[7]](#引用) . This condition can result in denial-of-service (DoS) scenarios, where the software becomes unresponsive due to resource exhaustion, such as excessive CPU or memory consumption [[2]](#引用) .

The issue is categorized under multiple CWEs: CWE-834, indicating excessive iteration, and CWE-835, which relates to a loop with an unreachable exit condition [[8]](#引用) [[7]](#引用) [[1]](#引用) . The exploitability of this vulnerability typically necessitates user interaction, as an attacker must entice the victim to open or render the malicious PDF file [[8]](#引用) [[2]](#引用) .

The Common Vulnerability Scoring System (CVSS) has assessed the severity of this vulnerability with base scores varying between 3.7 and 5.5, typically rated as 'Low' to 'Medium' [[8]](#引用) [[2]](#引用) . The primary impact centers on availability, while confidentiality and integrity are not significantly affected [[2]](#引用) .

Resolution for this vulnerability was provided in version 2.0.24 of Apache PDFBox, with strong recommendations for users to upgrade to this or later versions to avoid potential exploitation [[8]](#引用) [[3]](#引用) [[1]](#引用) .

## 排查步骤(生成式)

- Check for Apache PDFBox: Verify if your application uses Apache PDFBox, the vulnerable package.
  
```bash
  dpkg -l | grep pdfbox
```
  This check confirms whether the product relies on Apache PDFBox, establishing the foundation for further vulnerability assessment.

- Review affected versions: If Apache PDFBox is present, confirm the version. If the version range is from 2.0.0 to 2.0.23 (inclusive), the installation is vulnerable.
  
```bash
  dpkg -l | grep pdfbox | awk '{print $3}'
```
  Knowing the version is critical to assess whether the specific installation is exposed to this CVE.

- Check if the PDF processing feature is active: Verify whether the application processes PDF files, as this feature must be enabled for exploitation to occur.
  
```bash
  grep -r "loadPdf" /path/to/application/config
```
  This check helps determine if the potentially vulnerable code that could lead to a denial of service is invoked in the application.

- Monitor for input handling: Ensure that the PDF processing mechanism contains checks for malformed PDF files or incorporates maximum iteration limits.
  
```bash
  grep -r "while(true)" /path/to/pdf/processing/code
```
  This examination verifies the robustness of input handling within the code, identifying if adequate safeguards against the vulnerability are implemented.

## 受影响版本(生成式)

- Apache PDFBox: Versions 2.0.0 through 2.0.23 (inclusive) are vulnerable [[7]](#引用) .

## 不受影响版本(生成式)

- Component: Apache PDFBox  
- Unaffected Versions:  
  - 2.0.24  
  - 2.0.25  
  - 2.0.26  
  - 2.0.27  
  - 2.0.28  
  - 2.0.29  
  - 2.0.30  
  - 2.0.31  
  - 2.0.32  
  - 2.0.33  
  - 2.0.34  
  - 2.0.35  
  - 2.0.36  
  - 2.0.37  
  - 2.0.38 and later (inclusive) [[8]](#引用) [[7]](#引用) [[10]](#引用) [[11]](#引用) [[12]](#引用) [[1]](#引用) 

## 规避方案(生成式)

1. Upgrade to Safe Version: Update your Apache PDFBox library to version 2.0.24 or later to mitigate this vulnerability [[8]](#引用) . This version includes essential fixes that prevent infinite loops when processing specially crafted PDF files [[10]](#引用) .  Implementation Steps: - Identify the location where Apache PDFBox is included in your project (e.g., in a Maven 'pom.xml' or Gradle build file). - If using Maven, change the dependency version number to 2.0.24 or higher: 
```xml <dependency> <groupId>org.apache.pdfbox</groupId> <artifactId>pdfbox</artifactId> <version>2.0.24</version> </dependency> ``` - For Gradle, modify the dependency as follows: 
```groovy implementation 'org.apache.pdfbox:pdfbox:2.0.24' ``` - Rebuild your project to apply the changes.  Effectiveness: This action resolves the vulnerability directly by including changes that prevent denial of service from infinite loops caused by malicious PDFs [[2]](#引用) . 2. PDF Validation: Implement a preprocessing step to validate incoming PDF files before they are processed by Apache PDFBox. Ensure that files conform to expected structures and do not contain constructs that could lead to excessive iterations.  Implementation Steps: - Utilize a PDF validation library that can analyze PDF structure, such as Apache Preflight or pdfbox-app. - Before loading a PDF into Apache PDFBox, perform a validation check: 
```java PDDocument document = PDDocument.load(new File('input.pdf')); if (!isValidPdf(document)) { throw new IllegalArgumentException('Invalid PDF structure'); } // Proceed with processing the document ``` - Create the 'isValidPdf' method to include rules for checking PDF integrity and structure.  Effectiveness: By ensuring that only well-formed PDFs are processed, this measure greatly reduces the risk of triggering the infinite loop vulnerability .

## 受影响版本(总结式)

- Component: Apache PDFBox
    - Affected Versions: 2.0.0 through 2.0.23 (inclusive) [[7]](#引用) 

## 不受影响版本(总结式)

- Component: Apache PDFBox
    - Unaffected Versions: 2.0.24 and later (inclusive) [[8]](#引用) [[7]](#引用) [[10]](#引用) [[11]](#引用) [[12]](#引用) [[1]](#引用) 

## 排查步骤(总结式)

- Check Installation: Confirm that Apache PDFBox is installed on the system; the vulnerability is irrelevant if the library is absent [[8]](#引用) .

- Check Version: Verify that the version of Apache PDFBox is 2.0.23 or earlier, as these are the affected versions [[7]](#引用) . Upgrading to version 2.0.24 or higher mitigates the vulnerability [[7]](#引用) .

- Review PDF File Handling: Analyze how the application processes PDF files, particularly those that may be manipulated or untrusted [[11]](#引用) .

- Monitor Resource Consumption: Test loading various PDF files to detect any signs of the application entering an infinite loop or experiencing excessive resource use [[10]](#引用) .

## 规避方案(总结式)

- Upgrade to Apache PDFBox version 2.0.24 or later [[8]](#引用) .
- Ensure that any affected PDF files are not processed by Apache PDFBox to prevent triggering the infinite loop [[10]](#引用) .
- Apply the latest security updates provided by stakeholders for dependencies, if necessary [[2]](#引用) .

## 利用分析

CVE-2021-31812 is a critical vulnerability in Apache PDFBox, affecting versions 2.0.23 and earlier [[8]](#引用) . An attacker can exploit this vulnerability by following these steps: 1. PDF Crafting: The attacker creates a specifically crafted PDF file that contains elements designed to exploit the infinite loop vulnerability within PDFBox [[8]](#引用) [[11]](#引用) . The structure and content manipulation of the PDF are essential for triggering this behavior during the file loading process. 2. Delivery Mechanism: The malicious PDF file must be delivered to a target system that is running a vulnerable version of PDFBox. This can be executed through various means, such as email attachments, website uploads, or other methods where the target might open the file [[8]](#引用) [[10]](#引用) . 3. Execution: The exploit occurs when the victim or another process opens the crafted PDF file using the vulnerable version of Apache PDFBox. This action results in the application entering an infinite loop, leading to a denial of service condition as system resources (CPU, memory) may become overwhelmed [[8]](#引用) [[9]](#引用) . To mitigate this vulnerability, users are strongly advised to upgrade to Apache PDFBox version 2.0.24 or later, which resolves the issue [[8]](#引用) .

## 根因分析

The vulnerability in Apache PDFBox, referenced as CVE-2021-31812, arises primarily from issues in the 'BaseParser.java' file that lead to an infinite loop while processing corrupted PDF files [[8]](#引用) . The key root cause is a lack of proper validation and termination conditions during the parsing of COS arrays and dictionary objects [[7]](#引用) .  The 'parseCOSArray' function lacks adequate checks for corrupted object references, which can cause the parser to enter an infinite loop when faced with malformed input [[2]](#引用) . This line: 


```java
pbo = parseDirObject();
```

attempts to parse elements into the array without checking if the object is valid. If the input data is corrupted in such a way that valid objects cannot be read, the parser continues to attempt reading indefinitely without encountering an end condition or error state [[9]](#引用) . The method 'parseCOSDictionaryValue' also suffers from insufficient validation, particularly when attempting to retrieve values that could lead to infinite iterations during parsing [[10]](#引用) . The line: 


```java
COSBase value = parseDirObject();
```

doess not verify that 'value' is a valid object before proceeding, which can result in objects that keep returning invalid states, leading to continuous iteration through subsequent calls to 'parseCOSDictionaryValue' without properly identifying the end of the parsing loop [[4]](#引用) . Related to both the array and dictionary parsing is how malformed or corrupted objects result in repeated recursive calls that do not conclude properly, causing stack overflows or infinite loops [[8]](#引用) . The function: 


```java
private boolean readUntilEndOfCOSDictionary() throws IOException
{
    ...
    while (c != -1 && c != '/' && c != '>')
    {
        ...
        // in addition to stopping when we find / or >, we also want
        // to stop when we find endstream or endobj.
        if (c == E)
        {
            ...
        }
        ...
    }
}
```

This segment shows an implicit assumption that certain control characters will always eventually be found; however, when parsing corrupted streams, the assumption fails, and no control character is reached [[1]](#引用) .

 Summary of Issues:
1. Absence of Corruption Checks: The code frequently fails to validate input before proceeding with parsing, missing opportunities to break out of loops or handle errors gracefully [[6]](#引用) .
2. Infinite Recursion: Recursive calls in the parsing methods utilize assumptions about the structure of valid PDF files and are not resilient to unexpected variations in input data [[7]](#引用) .
3. Improper Object Handling: Non-standard object references lead to conditions where the parser continues to execute without a definitive end point [[9]](#引用) .

By addressing these issues, the patch prevents infinite loops and excessive resource consumption while processing potentially corrupted PDF files, thereby mitigating denial-of-service concerns.

## 修复解释

The commit ID for this patch is `e97bc3a30e47594ddb0db50154ff009ea0c2ef71`, which addresses the denial of service vulnerability CVE-2021-31812 in the Apache PDFBox library, specifically in the file located at `pdfbox/src/main/java/org/apache/pdfbox/pdfparser/BaseParser.java`.

The following changes in the `parseCOSArray` method fix the infinite loop vulnerability:


```java
-                LOG.warn("Corrupt object reference at offset " +
-                        seqSource.getPosition() + ", start offset: " + startPosition);
```

This line is modified to improve clarity in logging:


```java
+                LOG.warn("Corrupt array element at offset "
+                        + seqSource.getPosition() + ", start offset: " + startPosition);
```
 
This change clarifies that the reference being logged is specifically an array element, which aids in understanding the context of the issue.

Additionally, this code snippet is added to prevent potential infinite recursion:


```java
+                // return immediately if a corrupt element is followed by another array
+                // to avoid a possible infinite recursion as most likely the whole array is corrupted
+                if (isThisTheEnd.isEmpty() && seqSource.peek() == '[')
+                {
+                    return po;
+                }
```

This newly introduced check effectively avoids the case where an unparseable item in the array leads to re-triggering the parsing for another array element, thus preventing an infinite loop that could cause a denial of service. By implementing this, the code can safely skip over invalid elements while handling corrupt arrays. 

Together, these changes help ensure that the parser can handle malformed PDFs more robustly, avoiding conditions that could lead to excessive CPU usage or application crashes.
The patch for the code is at: https://api.github.com/repos/apache/pdfbox/commits/e97bc3a30e47594ddb0db50154ff009ea0c2ef71

## 引用

- [1]  https://nvd.nist.gov/vuln/detail/CVE-2021-31812
- [2]  https://www.secpod.com/blog/oracle-releases-critical-security-updates-january-2023-patch-now/
- [3]  https://seclists.org/oss-sec/2021/q2/215
- [4]  https://cert.360.cn/daily?date=2021-06-16
- [5]  https://cvedetails.com/cve/CVE-2021-31812
- [6]  https://www.securecoding.cert.org/confluence/display/cert/Excessive+Iteration
- [7]  https://www.cvedetails.com/cve/CVE-2021-31812
- [8]  https://cve.circl.lu/cve/CVE-2021-31812
- [9]  https://www.anquanke.com/post/id/244514
- [10]  https://vulners.com/cve/CVE-2021-31812
- [11]  https://app.soos.io/research/vulnerabilities/CVE-2021-31812
- [12]  http://seclists.org/oss-sec/2021/q2/215

