## 漏洞描述

Apache Commons IO in Apache versions 2.2 to 2.6 is vulnerable to a limited path traversal issue due to improper input handling in the FileNameUtils.normalize method [[7]](#引用) [[3]](#引用) . This vulnerability allows an attacker to potentially access files in the parent directory via unsafe input strings such as "//../foo" or "\\..\foo" [[7]](#引用) [[6]](#引用) . The calling code uses the resultant path value to access files, but traversal is limited to one parent directory [[7]](#引用) . To mitigate this vulnerability, users are advised to upgrade to Apache Commons IO version 2.7 or later, which improves input handling by returning null for invalid paths, thereby preventing unauthorized file access [[7]](#引用) [[3]](#引用) .

## 详细描述

CVE-2021-29425 is a limited path traversal vulnerability identified in Apache Commons IO versions 2.2 through 2.6 [[7]](#引用) . The vulnerability is triggered by improper input strings processed by the FileNameUtils.normalize method, such as '//../foo' or '\..\foo' [[7]](#引用) [[3]](#引用) . When these inputs are provided, the method incorrectly normalizes the paths without rejecting them, thus allowing the potential for unauthorized access to files located in the parent directory [[6]](#引用) . However, the vulnerability is limited to this scope as it does not extend access beyond the parent directory [[7]](#引用) . The affected method and its associated functions do not directly interact with the file system; they manipulate path strings that can be used later to construct actual file paths, which could lead to security issues if the returned paths are utilized without proper validation [[3]](#引用) . The vulnerability has been assigned internal tracking identifiers IO-556 and IO-559 for reference [[7]](#引用) [[3]](#引用) . To mitigate this vulnerability, it is recommended to avoid passing any unsafe input to the FileNameUtils.normalize method [[3]](#引用) . Users should upgrade to Apache Commons IO version 2.7 or later, wherein the normalization method has been amended to return null for invalid input, significantly reducing the risk of exploitation [[7]](#引用) [[3]](#引用) .

## 排查步骤(生成式)

- Check for use of Apache Commons IO: Verify if your application utilizes Apache Commons IO, which is the vulnerable package.
  
```bash
  grep -r "commons-io" /path/to/project
```
  This command scans your project directory for references to Apache Commons IO, confirming its usage and relevance to vulnerability CVE-2021-29425..

- Review affected versions: If Apache Commons IO is used, check the version installed. The version must be between 2.2 and 2.6 (inclusive) to be considered vulnerable.
  
```bash
  mvn dependency:list | grep commons-io
```
  This command checks for the specific version of the commons-io library used in a Maven project, helping to identify potential vulnerability presence..

- Check if the vulnerable method is called: Determine if the method `FileNameUtils.normalize` is invoked in your application, as it is the entry point for the vulnerability.
  
```bash
  grep -r "FileNameUtils.normalize" /path/to/project
```
  By finding references to this method in your codebase, you can confirm whether your application is capable of being exploited..

- Analyze user input handling: Review how user input is sanitized before passing it to `FileNameUtils.normalize`. Ensure that there are mechanisms to validate or restrict input.
  
```bash
  grep -r "userInput" /path/to/project
```
  Checking for patterns in how user input is managed informs the analysis of potential vulnerabilities and their exposure due to improper handling..

## 受影响版本(生成式)

- Apache Commons IO: 2.2 to 2.6 (inclusive) [[7]](#引用) 

## 不受影响版本(生成式)

- Apache Commons IO: 2.7 and later [[7]](#引用) 
- Apache Commons IO: 2.8 and later [[1]](#引用) 

## 规避方案(生成式)

1. Patch Management: Upgrade Apache Commons IO to version 2.7 or later [[7]](#引用) . This version includes enhanced input validation that prevents malicious input from being processed. To implement this mitigation, execute the following Maven command in your project directory:
   
```bash
   mvn dependency:update -Dincludes=commons-io:commons-io:2.7
```
   This command updates the dependency to ensure you're using the secure version. Upgrading to version 2.7 or later modifies the behavior of the `FileNameUtils.normalize` method to return `null` for invalid paths, thus preventing unauthorized access to files in parent directories [[6]](#引用) .
   

2. Input Validation: Implement manual checks to ensure only safe input is passed to the `FileNameUtils.normalize` method [[1]](#引用) . Modify the `accessFile` method to include a validation step before normalizing the user input. Here’s an example of how you could implement this in Java:
   
```java
   public void accessFile(String userInput) {
       if (isInputSafe(userInput)) {
           String normalizedPath = FilenameUtils.normalize(userInput);
           File file = new File(normalizedPath);
           String content = FileUtils.readFileToString(file, "UTF-8");
           System.out.println(content);
       } else {
           throw new IllegalArgumentException("Unsafe input provided.");
       }
   }

   private boolean isInputSafe(String input) {
       // Only allow alphanumeric and known safe characters
       return input.matches("[a-zA-Z0-9_/\.]+);
   }
```
   This addition prevents unsafe input from being normalized, helping to mitigate the vulnerability effectively. By ensuring only validated input is processed, the risk of path traversal is significantly reduced [[6]](#引用) .
   

## 受影响版本(总结式)

- Component: Apache Commons IO
    - Affected Versions: 2.2 to 2.6 (inclusive) [[7]](#引用) 


## 不受影响版本(总结式)

- Component: Apache Commons IO'
    '- Unaffected Versions: 2.6 and later' [[6]](#引用) 
- Component: Apache Commons IO
    '- Unaffected Versions: 2.7, 2.8' [[7]](#引用) [[3]](#引用) 
- Component: commons-io
    '- Unaffected Versions: 2.8 and later' [[1]](#引用) 

## 排查步骤(总结式)

- Check the installation of Apache Commons IO to ensure it is not between versions 2.2 and 2.6, as these are affected by CVE-2021-29425 [[7]](#引用) .
- Verify that the program has been upgraded to at least version 2.7 or later to mitigate the vulnerability [[7]](#引用) .
- Evaluate the inputs passed to the method `FileNameUtils.normalize` and avoid unsafe inputs like '//../foo' or '\..\foo' that could lead to exploitation [[6]](#引用) .

## 规避方案(总结式)

- Update commons-io from version 2.6 to Apache Commons IO version 2.7 or later [[1]](#引用) .
- Use only safe input when invoking the method `FileNameUtils.normalize` [[7]](#引用) .
- Avoid passing unsafe input to `FileNameUtils.normalize` [[8]](#引用) .
- Apply the patch available at the specified link to address the vulnerability [[6]](#引用) .

## 利用分析

CVE-2021-29425 affects Apache Commons IO versions 2.2 to 2.6, introducing a limited path traversal vulnerability in the FileNameUtils.normalize method [[7]](#引用) . The vulnerability is triggered when attackers provide malformed input strings, such as "//../foo" or "\\..\foo" [[2]](#引用) . To exploit this vulnerability, an attacker should undertake the following steps: 1. Identify an application or system that utilizes Apache Commons IO within the vulnerable version range (2.2 to 2.6) [[7]](#引用) . 2. Construct a malformed input string designed to exploit the vulnerability by manipulating the normalized path output. The inputs must not be valid file paths, as the goal is to exploit the normalization process [[2]](#引用) . 3. Call the method FileNameUtils.normalize using the crafted input string. The method will return the input string if it does not detect errors in normalization [[2]](#引用) . This returned value can then be improperly used by vulnerable code to construct file paths. 4. If the application fails to validate the output and uses it to access file paths, the attacker can gain access to files located in the parent directory, potentially exposing sensitive information [[7]](#引用) . Mitigation involves updating to Apache Commons IO version 2.7 or later, where the normalize method returns null for invalid inputs, effectively preventing this exploitation scenario [[7]](#引用) .

## 根因分析

The root cause of the vulnerability CVE-2021-29425 in Apache Commons IO's 'FilenameUtils' arises primarily from inadequate input validation in the 'normalize' method, specifically within the 'doNormalize' function [[7]](#引用) . This method fails to correctly handle potentially dangerous paths, allowing for limited path traversal, particularly through sequences like '//../foo' or '\..\foo' [[7]](#引用) [[6]](#引用) . A breakdown of the critical components contributing to this vulnerability highlights multiple related issues:

1. Inadequate handling of double dot segments ('..'): The method 'doNormalize' includes logic to handle '..' segments that represent moving up one directory in the file system. However, it does not effectively enforce boundaries on how many parent directories can be traversed [[6]](#引用) .

Example snippet from 'doNormalize':

```java
// double dot slash
outer:
for (int i = prefix + 2; i < size; i++) {
    if (array[i] == separator && array[i - 1] == '.' && array[i - 2] == '.') {
        if (i == prefix + 2) {
            return null;
        }
        // ...[additional logic]...
    }
}
```
Here, while the code checks for the condition where a double dot should be processed, it lacks checks to restrict traversal beyond a single directory level when manipulating potentially unsafe paths. This can lead to unauthorized access by allowing sequences that climb up the directory tree [[7]](#引用) [[6]](#引用) .

2. Insufficient path validation in the 'getPrefixLength' function: The 'getPrefixLength' function does not adequately validate the prefix of the provided file names, which can inadvertently allow invalid or malformed names, especially regarding the usage of sequential separators [[7]](#引用) .

Example:

```java
if (isSeparator(ch0) && isSeparator(ch1)) {
    int posUnix = fileName.indexOf(UNIX_SEPARATOR, 2);
    int posWin = fileName.indexOf(WINDOWS_SEPARATOR, 2);
    // ...[additional checks]...
}
```
While it checks for certain patterns, it still permits conditions that can be exploited for directory traversal, especially with sequences like '//' or '\' [[6]](#引用) . An attacker could craft input leading to unintended access paths.

3. Lack of return value sanitization for invalid paths: When the 'doNormalize' method encounters problematic paths, it returns 'null', but the calling code may not handle this correctly, allowing further processing of null outputs. This lack of sanitization can lead to further exploitation [[7]](#引用) .

Example:

```java
return doNormalize(fileName, SYSTEM_SEPARATOR, false);
```
If an invalid input returns 'null', subsequent operations relying on a valid string may inadvertently lead to file access attempts using invalid paths.

In summary, the root cause of the vulnerability stems from inadequate normalization processes, poor input validation mechanisms, and insufficient handling of returns from normalization operations [[6]](#引用) . Each aspect creates a potential avenue for unauthorized file access, particularly when dealing with traversed paths that should be tightly controlled.

## 修复解释

In the patch identified by commit ID `fe38f8892a2e99cfb6b941c48a57e1415d7ab223`, implemented in the file `FilenameUtils.java` located at `src/main/java/org/apache/commons/io/`, the method `isIPv4Address` was modified to improve its verification process.

The following changes were made within the `isIPv4Address` method:


```java
-        for (int i = 1; i < 5; i++) {
+        for (int i = 1; i <= 4; i++) {
```

This change refines the loop condition to ensure that it iterates exactly four times, corresponding to the four octets in an IPv4 address.

Additionally, the following lines were removed:


```java
-            if (ipSegment == null || ipSegment.length() == 0) {
-                return false;
-            }
-            int iIpSegment = 0;
-            try {
-                iIpSegment = Integer.parseInt(ipSegment);
-            } catch(NumberFormatException e) {
-                return false;
-            }
```

These removals eliminate unnecessary checks for null or empty strings within each segment as well as the try-catch block for parsing integers. Instead, the line:


```java
+            int iIpSegment = Integer.parseInt(ipSegment);
```

is left to directly attempt parsing the integer from the `ipSegment`, which is expected to be valid due to the previous regex matching. 

Overall, this patch enhances the efficiency of the `isIPv4Address` method by reducing unnecessary checks and streamlining the logic, while still adhering to the need for rigorous validation inherent to the method's functionality.The patch for the code is at: https://api.github.com/repos/apache/commons-io/commits/fe38f8892a2e99cfb6b941c48a57e1415d7ab223

## 引用

- [1]  http://markmail.org/message/lmztv7bjypcjc5hn?q=struts+list:org%2Eapache%2Estruts%2Edev
- [2]  http://markmail.org/message/lmztv7bjypcjc5hn?q=struts+list:org%2Eapache%2Estruts%2Edev:
- [3]  Microsoft Outlook <MicrosoftExchange329e71ec88ae4615bbc36ab6ce41109e@huawei.com
- [4]  Microsoft Outlook
- [5]  http://www.cnnvd.org.cn/web/xxk/ldxqById.tag?CNNVD=CNNVD=CNNVD-202104-702
- [6]  http://www.cnnvd.org.cn/web/xxk/ldxqById.tag?CNNVD=CNNVD-202104-702
- [7]  http://seclists.org/oss-sec/2021/q2/16
- [8]  Microsoft Outlook <MicrosoftExchange329e71ec88ae4615bbc36ab6ce41109e@huawei.com>

