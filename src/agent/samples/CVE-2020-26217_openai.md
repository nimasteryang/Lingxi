## 漏洞描述

XStream in ThoughtWorks XStream versions less than 1.4.14 is vulnerable to Remote Code Execution due to improper handling of XML deserialization that allows attackers to bypass a blacklist [[6]](#引用) . This vulnerability allows an unauthorized remote attacker to execute arbitrary code on the server via specially crafted XML payloads [[11]](#引用) . The exploitation relies on manipulating processed input streams, enabled by the use of Java reflection during unmarshalling, which can create instances that execute injected commands [[5]](#引用) [[2]](#引用) .

## 详细描述

CVE-2020-26217 is a critical remote code execution vulnerability within the XStream library, which is commonly utilized for Java object serialization into XML and back [[12]](#引用) . This vulnerability is rooted in the insecure handling of XML input during the deserialization process [[12]](#引用) . Specifically, it allows an attacker to craft malicious XML payloads that leverage improper validation, thereby enabling the execution of arbitrary code on the server hosting the application utilizing the affected versions of XStream (up to and including version 1.4.13) [[4]](#引用) . The exploitation occurs during a process called unmarshalling, where the library reconstructs objects based on the XML data received [[5]](#引用) . Attackers can manipulate this process by injecting malicious commands into XML data that XStream processes, thus facilitating actions like executing shell commands [[4]](#引用) [[5]](#引用) . The vulnerability is particularly concerning as it bypasses typical blacklisting mechanisms, exploiting the system's reliance on pre-defined object types without adequate security validation [[6]](#引用) . Security assessments indicate a CVSS score of 9.8, categorizing it as a severe threat, positioning it among notable vulnerabilities that require immediate remediation [[6]](#引用) . The XStream project released a patch on November 16, 2020, addressing this flaw and ensuring systems no longer process untrusted XML data in a way that could lead to code execution [[12]](#引用) . Organizations utilizing XStream are urged to upgrade to versions 1.4.14 or later and implement proper security controls to mitigate risks associated with this vulnerability [[2]](#引用) .

## 排查步骤(生成式)

- Check for XStream: Verify if your installation uses the XStream library, which is the vulnerable package.
  
```bash
  grep -r "xstream" /path/to/your/project
```
  This command searches through the project files to confirm if XStream is included in the application. Identifying the presence of the library is crucial to establish a baseline for vulnerability assessment.

- Review affected versions: If XStream is found, check the version of XStream. If the version is less than 1.4.14, the installation is vulnerable.
  
```bash
  java -cp /path/to/xstream.jar com.thoughtworks.xstream.XStream version
```
  This command retrieves the version of the XStream library. Detecting a vulnerable version is essential as it directly correlates to the potential risk of remote code execution.

- Check for the use of XML deserialization: Determine whether your application performs XML deserialization using XStream, which exposes it to the vulnerability.
  
```bash
  grep -r "fromXML" /path/to/your/project
```
  This command identifies instances where the `fromXML` method is called. Establishing this confirms whether the vulnerable feature is active, indicating a higher risk of exploitation.

- Analyze XML inputs for unsafe configurations: Check the application's configuration to see if it allows untrusted XML inputs without strict validation.
  
```bash
  grep -r "<input>" /path/to/your/config/files
```
  This command looks for any input handling configuration that permits XML input. As this can lead to RCE if not properly secured, ensuring no untrusted XML is processed is key to mitigating exploitation.

## 受影响版本(生成式)

- XStream versions prior to 1.4.14 are considered vulnerable [[8]](#引用) .
- Specific vulnerable versions include 1.4.13 and earlier (inclusive) [[5]](#引用) .
- Version 1.4.11.1 is also noted as vulnerable [[1]](#引用) .
- The vulnerability extends to all XStream versions released before the security update on November 16, 2020 [[12]](#引用) .

## 不受影响版本(生成式)

- Unaffected versions of the XStream component include:
  - 1.4.14 and later [[8]](#引用) [[6]](#引用) [[3]](#引用) 
  - 1.4.13 and later [[4]](#引用) 
  - 1.4.11.1 or later [[1]](#引用) 

These versions are confirmed to be unaffected by CVE-2020-26217.

## 规避方案(生成式)

1. Patch Management: Upgrade XStream to version 1.4.14 or later [[6]](#引用) . - Action: Download the latest version of XStream from the official site at [XStream Download](https://x-stream.github.io/download.html) and replace the existing version in your application. If you are using Maven, update your `pom.xml` file with the following dependency: 
```xml <dependency> <groupId>com.thoughtworks.xstream</groupId> <artifactId>xstream</artifactId> <version>1.4.14</version> </dependency> ``` - Description: Upgrading to version 1.4.14 mitigates the vulnerability by applying security patches that rectify the improper handling of XML deserialization [[1]](#引用) . This is crucial in preventing unauthorized remote code execution which can compromise your application and server [[12]](#引用) . 

2. XML Input Validation: Implement strict validation for XML payloads . - Action: Use a schema validation mechanism (e.g., XML Schema Definition (XSD) or DTD) to validate incoming XML inputs. Integrate the following in your Java application: 
```java import javax.xml.XMLConstants; import javax.xml.transform.stream.StreamSource; import javax.xml.validation.Schema; import javax.xml.validation.SchemaFactory; import javax.xml.validation.Validator; public class XMLValidator { public static void validate(String xmlFilePath, String xsdFilePath) throws Exception { SchemaFactory factory = SchemaFactory.newInstance(XMLConstants.W3C_XML_SCHEMA_NS_URI); Schema schema = factory.newSchema(new File(xsdFilePath)); Validator validator = schema.newValidator(); validator.validate(new StreamSource(new File(xmlFilePath))); } } ``` - Description: Validating XML inputs against a predefined schema helps ensure that only expected and safe structures are processed, thus mitigating risks of injecting malicious payloads that can lead to RCE . It acts as the first line of defense against malformed or malicious XML data . 

## 受影响版本(总结式)

- Component: XStream
    - Affected Versions: < 1.4.14 [[8]](#引用) 
    - Affected Versions: 1.4.11.1 [[10]](#引用) 
    - Affected Versions: 1.4.13 [[4]](#引用) 
    - Affected Versions: <= 1.4.13 [[5]](#引用) 

## 不受影响版本(总结式)

- Component: XStream
    - Unaffected Versions: 1.4.13 and later [[4]](#引用) 
    - Unaffected Versions: 1.4.14 and later [[8]](#引用) 
    - Unaffected Versions: 1.4.11.1 or later [[1]](#引用) 

## 排查步骤(总结式)

- Program Installation: Verify that XStream is installed in your application and check if it is being actively utilized [[12]](#引用) .

- Version Check: Confirm that the version of XStream in use is 1.4.14 or later, as versions prior to this are vulnerable to exploitation (specifically, versions 1.4.13 or earlier) [[8]](#引用) [[5]](#引用) [[3]](#引用) .

- Configuration Review: Ensure that the application is configured securely, enabling security mode during installation and applying relevant patches to mitigate risks [[12]](#引用) [[4]](#引用) .

- Utilize Security Products: Employ security software or services that can detect and protect against this specific vulnerability, and be vigilant in applying any security updates regarding CVE-2020-26217 [[12]](#引用) [[6]](#引用) .

## 规避方案(总结式)

- Ensure all software using XStream is updated to the latest version (1.4.14 or higher) that includes security patches for CVE-2020-26217 [[12]](#引用) .
- Implement updates to security configurations in XStream, particularly initializing security mode and modifying the 'securityInitialized' flag in version 1.4.11 [[4]](#引用) .
- Add 'java.lang.ProcessBuilder' and 'javax.imageio.ImageIO$ContainsFilter' to the blacklist in XStream 1.4.14 to defend against exploitation [[4]](#引用) [[5]](#引用) .
- Use Tencent T-Sec Host Security for vulnerability detection related to XStream [[12]](#引用) .
- Activate rules from Tencent T-Sec Cloud Firewall, updated post-November 16, 2020, to detect and block exploit attempts [[12]](#引用) .
- Leverage built-in intrusion prevention capabilities in Tencent Cloud Firewall for active defense [[12]](#引用) .
- Utilize updated detection from Tencent T-Sec Advanced Threat Detection System to identify exploit attempts [[12]](#引用) .
- Conduct asset self-audits and preventive measures against hacker attacks [[6]](#引用) .

## 利用分析

CVE-2020-26217 is a remote code execution vulnerability in the XStream framework affecting versions up to 1.4.13 [[12]](#引用) . An attacker can exploit this vulnerability by following these steps: 1. Identify Target Application: The attacker first identifies a web application utilizing XStream for XML processing, specifically one running a vulnerable version prior to 1.4.14 [[11]](#引用) . 2. Craft Malicious XML Payload: A malicious XML payload is created, specifically designed to leverage the way XStream handles unmarshalling. This includes embedding references to classes that can execute arbitrary shell commands [[4]](#引用) . 3. Send Malicious Payload: The crafted XML payload is sent to the vulnerable application, typically over web requests that the application processes with XStream [[8]](#引用) . 4. Trigger the Unmarshal Process: Upon receipt of the malicious XML, the application invokes the `fromXML()` method of the `com.thoughtworks.xstream.XStream` class, which processes the XML data and calls the `unmarshal()` method. During this process, it collects type information from the XML [[5]](#引用) . 5. Class Instantiation and Command Execution: The unmarshalling mechanism inadvertently instantiates objects of classes referenced in the XML payload. If these classes include methods capable of executing system commands, the payload can manipulate the application’s flow to execute arbitrary code or execute shell commands, particularly through methods like `ProcessBuilder.start()` [[8]](#引用) [[5]](#引用) . 6. Achieve Remote Code Execution: Successful execution of the injected commands grants the attacker control over the server, completing the exploit [[2]](#引用) . Preventative measures involve upgrading to versions post-1.4.14, where additional checks and blacklisting mechanisms mitigate the vulnerability's impact [[3]](#引用) . Additionally, using security products with virtual patching capabilities can provide protection against exploitation attempts [[12]](#引用) .

## 根因分析

The vulnerability CVE-2020-26217 in XStream is rooted in the improper handling of XML deserialization, which leads to the potential for Remote Code Execution (RCE) through untrusted XML input [[12]](#引用) . Specifically, the issue lies within the way the library handles type permissions during the deserialization process [[3]](#引用) .  

 Root Cause Parts of the Vulnerability  

 1. Lack of Proper Type Restriction  
The original code does not effectively restrict certain types from being deserialized. This lack of controls allows attackers to specify types in an XML payload that can potentially invoke dangerous classes [[12]](#引用) .  

Relevant Code Snippet:  

```java  
// XStream.java  
addPermission(AnyTypePermission.ANY);  
denyTypes(new String[] {"java.beans.EventHandler", "javax.imageio.ImageIO$ContainsFilter"});  
```  
The code above attempts to deny permissions for specific dangerous types, but the initial allowance of `AnyTypePermission.ANY` means that without proper configuration, virtually any type can be instantiated [[8]](#引用) .  

This permissiveness directly contributes to allowing malicious types to bypass intended security controls, potentially leading to RCE. An attacker could craft an XML payload that includes a type not adequately secured against, leading to the instantiation of arbitrary classes [[4]](#引用) .  

 2. Incomplete Blacklist  
Before the patch, there were insufficient types on the 'blacklist' meant to prevent deserialization of potentially dangerous constructs, like `ProcessBuilder`, which can lead to executing arbitrary commands on the server [[3]](#引用) .  

Relevant Code Snippet:  

```java  
// Patch shows the addition of ProcessBuilder to the blacklist  
denyTypes(new String[] {"java.beans.EventHandler", "javax.imageio.ImageIO$ContainsFilter"});  
```  
In the pre-patch code, `ProcessBuilder` was not explicitly denied, thereby allowing it in XML input, which can be misused to execute arbitrary shell commands [[4]](#引用) [[3]](#引用) . This absence of specific blacklisting creates a significant risk whereby attackers could leverage these types for RCE.  

 3. Insufficient Security Initialization  
The security model initialization in the existing implementation was insufficient, which led to potential gaps in securing the deserialization process against malicious input [[3]](#引用) .  

Relevant Code Snippet:  

```java  
// XStream.java  
setupSecurity();  
securityInitialized = false;  
```  
Here, the `securityInitialized` flag being set to false indicates that the security setup did not properly handle permissions before accepting XML inputs for deserialization [[3]](#引用) . Such a configuration signifies a failure to implement necessary security precautions in the default state, permitting potentially harmful behavior.  

 Summary of Issues  
- Lack of Proper Type Restriction allows any type to be instantiated, leading to bypassing security settings [[3]](#引用) .  
- Incomplete Blacklist does not prevent specific dangerous types, such as `ProcessBuilder`, from being deserialized and used unfettered [[4]](#引用) .  
- Insufficient Security Initialization leaves the deserialization process open to exploitation due to misconfigured or absent security measures [[3]](#引用) .  

Each of these parts interrelates directly to the vulnerability, resulting in a breach that could be exploited, allowing unauthorized command execution on the server [[12]](#引用) . The applied patch effectively addresses these issues by adding stricter type checks and enhancing the security measures associated with XML payload deserialization.

## 修复解释

The patch updates the security settings in the `XStream.java` file located at `xstream/src/java/com/thoughtworks/xstream/`. The commit ID for this change is `f8abc1ac909d26c69c752ba4a987b7f21c4dccd0`.

### Changes Made:

1. Security Adjustment:
   The line in the `setupSecurity()` method that previously read:
   
```java
   denyTypes(new String[] {"java.beans.EventHandler", "javax.imageio.ImageIO$ContainsFilter"});
```
   was modified to:
   
```java
   denyTypes(new String[] {"java.beans.EventHandler", "java.lang.ProcessBuilder", "javax.imageio.ImageIO$ContainsFilter"});
```

   This change adds `java.lang.ProcessBuilder` to the default blacklist, which means that any XML containing this type will not be deserialized unless explicitly configured to allow it. This mitigates the risk of remote code execution by preventing malicious XML from instantiating potentially harmful Java objects through insecure deserialization.

2. Documentation Update:
   In the `changes.html` file located at `xstream-distribution/src/content/changes.html`, the documentation was updated to reflect this new addition to the blacklist. It states:
   
```html
   The types java.lang.ProcessBuilder and javax.imageio.ImageIO$ContainsFilter are now part of the default
   blacklist and the deserialization of XML containing one of the two types will fail. You will must enable these
   types by explicit configuration, if you need them.
```

This combined update enhances the security posture of the XStream library by ensuring more types are controlled during the deserialization process, thus reducing the potential attack surface for vulnerabilities related to untrusted XML input.The patch for the code is at: https://api.github.com/repos/x-stream/xstream/commits/f8abc1ac909d26c69c752ba4a987b7f21c4dccd0

## 引用

- [1]  http://markmail.org/message/qqdakqqdqwvq5rrk?q=struts+list:org%2Eapache%2Estruts%2Edev:
- [2]  https://help.aliyun.com/noticelist/articleid/1060749888.html
- [3]  https://www.cnvd.org.cn/flaw/show/CNVD-2020-63975
- [4]  https://www.freebuf.com/articles/web/256286.html
- [5]  https://paper.seebug.org/1417/
- [6]  https://www.anquanke.com/post/id/222666
- [7]  https://x-stream.github.io/download.html
- [8]  https://www.secpulse.com/archives/146418.html
- [9]  https://www.anquanke.com/post/id/222666/
- [10]  http://markmail.org/message/qqdakqqdqwvq5rrk?q=struts+list:org%2Eapache%2Estruts%2Edev
- [11]  https://github.com/novysodope/CVE-2020-26217-XStream-RCE-POC/commit/50a2e13ace57e994fd8a233054dbae46ea2101e4
- [12]  https://s.tencent.com/research/bsafe/1176.html

