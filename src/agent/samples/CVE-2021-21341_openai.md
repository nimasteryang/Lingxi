## 漏洞描述

XStream in XStream versions up to and including 1.4.15 is vulnerable due to a lack of input validation [[1]](#引用) , allowing an attacker to manipulate processed input streams [[3]](#引用) . This vulnerability allows an attacker to launch a denial-of-service (DoS) attack, causing service disruption via crafted input designed to create an infinite loop [[4]](#引用) . The previous security measures relied on a blacklist approach, which proved inadequate [[2]](#引用) , necessitating a more robust whitelist strategy to mitigate this risk effectively [[2]](#引用) .

## 详细描述

CVE-2021-21341 is a denial-of-service vulnerability identified in the XStream library, which is commonly utilized for XML serialization in Java applications [[3]](#引用) . The vulnerability allows an attacker to manipulate the processed input stream by injecting or replacing an instance of ByteArrayInputStream or its subclasses [[4]](#引用) . This manipulation can trigger an infinite loop within the application, leading to a denial-of-service condition [[1]](#引用) .

The vulnerability specifically affects versions of XStream up to and including 1.4.15 [[5]](#引用) . Due to the nature of this flaw, a successful exploit could result in unavailability of the affected service, potentially impacting system stability and availability [[2]](#引用) .

In response to this and other vulnerabilities, the security configuration of XStream has been updated to adopt a whitelist model for type handling [[2]](#引用) . This change restricts the permissible classes to only those explicitly defined by converters, in contrast to the previous blacklist approach that allowed all classes except those deemed unsafe [[2]](#引用) . This new configuration mitigates the risks associated with CVE-2021-21341 and improves overall security posture, especially against attacks aimed at deserializing arbitrary types from untrusted input [[5]](#引用) . 

Given the criticality assigned to this vulnerability, rated with a CVSS score of 7.0 or higher [[6]](#引用) , it is imperative for security professionals to employ the latest version of XStream and configure it correctly to safeguard against potential exploits.

## 排查步骤(生成式)

- Check for XStream: Verify if your installation uses XStream, which is the vulnerable package. 
  
```bash
  mvn dependency:tree | grep xstream
```  
  This check confirms whether the application relies on the XStream library, a critical step to establishing if the vulnerability could potentially affect the system.

- Check for affected versions: If XStream is used, determine the version of XStream in use. 
  
```bash
  mvn dependency:list | grep xstream
```  
  This helps to assess whether the installed version falls within the vulnerable range of versions, which is crucial for understanding vulnerability exposure.

- Analyze Input Handling: Review the application’s code for any usage of the `fromXML` method from XStream to check if it processes untrusted input.
  
```bash
  grep -r "fromXML(" /path/to/your/codebase/
```  
  This action directly checks if the application practices unsafe handling of input that can lead to exploitation, thereby identifying specific exploit paths.

- Check for input validation implementation: Ensure that input streams processed in the application are validated properly and ideally implement a whitelist approach.
  
```bash
  grep -r "setClassLoader" /path/to/your/codebase/
```  
  By confirming the absence of adequate input validation measures, this helps determine the application’s level of exposure to potential exploits, as a lack of proper validation could trigger a denial-of-service attack.

## 受影响版本(生成式)

- Component: XStream
  - Affected Versions: <= 1.4.15 [[3]](#引用) 
- Component: libxstream-java
  - Affected Versions: All versions prior to 1.4.11.1-1+deb10u3 for oldstable (buster); all versions prior to 1.4.15-3+deb11u1 for stable (bullseye) [[2]](#引用) 

## 不受影响版本(生成式)

- Unaffected Versions for Component: XStream
  - > 1.4.15 [[3]](#引用) 
  - >= 1.4.16 [[5]](#引用) 

- Unaffected Packages for Component: libxstream-java
  - 1.4.11.1-1+deb10u3 (for oldstable distribution) [[2]](#引用) 
  - 1.4.15-3+deb11u1 (for stable distribution) [[2]](#引用) 

## 规避方案(生成式)

1. Upgrade XStream:  
   - Action: Update your XStream dependency to version 1.4.16 or later. This version includes critical fixes that address CVE-2021-21341 [[3]](#引用) .  
   - Implementation: If you are using Maven for dependency management, modify your 'pom.xml' as follows:  
     
```xml  
     <dependency>  
       <groupId>com.thoughtworks.xstream</groupId>  
       <artifactId>xstream</artifactId>  
       <version>1.4.16</version>  
     </dependency>  
```  
   - Rationale: Upgrading to a version past 1.4.15 ensures that you are not only avoiding the identified vulnerabilities but also benefiting from improvements in the validation and handling of input streams, which eliminates the risk of denial-of-service (DoS) attacks through crafted XML inputs [[1]](#引用) .  
     

2. Implement a Whitelist for Deserialization:  
   - Action: Modify your XStream configuration to utilize a whitelist approach, explicitly defining which classes are permitted during deserialization [[5]](#引用) .  
   - Implementation: Update your code to include a secure configuration as follows:  
     
```java  
     XStream xstream = new XStream();  
     xstream.setClassLoader(getClass().getClassLoader());  
     xstream.allowTypes(new Class[] {YourSafeClass.class}); // Replace YourSafeClass with actual class names  
     Object object = xstream.fromXML(inputStream);  
```  
   - Rationale: By allowing only specific classes to be deserialized, you effectively mitigate the risk of arbitrary code execution resulting from maliciously crafted input, which is critical in preventing remote exploitation attempts [[5]](#引用) .  
   

## 受影响版本(总结式)

- Component: XStream'
    '- Affected Versions: <= 1.4.15'[[3]](#引用) '
- Component: libxstream-java'
    '- Affected Versions: All versions prior to 1.4.11.1-1+deb10u3 for oldstable (buster); all versions prior to 1.4.15-3+deb11u1 for stable (bullseye)'[[2]](#引用) '

## 不受影响版本(总结式)

- Component: XStream
    - Unaffected Versions: > 1.4.15 [[3]](#引用) 
- Component: XStream
    - Unaffected Versions: >= 1.4.16 [[5]](#引用) 
- Component: libxstream-java
    - Unaffected Versions: 1.4.11.1-1+deb10u3 (for oldstable distribution), 1.4.15-3+deb11u1 (for stable distribution) [[2]](#引用) 

## 排查步骤(总结式)

- Check if XStream is installed and ensure the configuration of the security framework permits only allowed types [[5]](#引用) . - Verify the version of XStream; affected versions are those less than or equal to 1.4.15 [[3]](#引用) [[1]](#引用) . - Upgrade to XStream version 1.4.16 or later if using an affected version [[5]](#引用) . - Review security settings to ensure a shift from a blacklist to a whitelist model has been implemented for added protection [[2]](#引用) .

## 规避方案(总结式)

- Upgrade XStream to the latest version to mitigate vulnerabilities [[3]](#引用) .
- Follow the official mitigation measures provided at the XStream security website [[3]](#引用) [[1]](#引用) .
- Configure XStream's security framework to use a whitelist for allowed types [[5]](#引用) .
- For Debian systems, upgrade libxstream-java to the following versions:
  - Version 1.4.11.1-1+deb10u3 for the oldstable distribution (buster) [[2]](#引用) .
  - Version 1.4.15-3+deb11u1 for the stable distribution (bullseye) [[2]](#引用) .
- Conduct asset self-inspections and preventive measures to avoid attacks [[4]](#引用) [[5]](#引用) .

## 利用分析

CVE-2021-21341 is a vulnerability in the XStream library, affecting its ability to securely handle object serialization and deserialization. An attacker can exploit this vulnerability by crafting a malicious input stream directed at an XStream service. The exploitation process includes: 1. Manipulating Input Stream: The attacker must create a specifically crafted input stream that can be processed by the vulnerable application using XStream. This crafted stream may include orchestrated serialized data that leads to unexpected behavior. 2. Injecting Malicious Data: The crafted input stream could replace or inject instances of 'ByteArrayInputStream' or its subclasses, effectively controlling how the data is read and processed during deserialization [[3]](#引用) [[4]](#引用) [[1]](#引用) . 3. Inducing Denial of Service: If successfully executed, the manipulation of the input stream can lead the application into an infinite loop, ultimately causing the service to become unresponsive, resulting in a denial of service [[3]](#引用) [[1]](#引用) [[5]](#引用) . 4. Exploiting Class Loading Mechanism: The underlying flaw stems from the inadequate validation of input against class loading risks, which previously relied on a blacklist model. Attackers can exploit the lack of proper input validation during deserialization to execute arbitrary code or disrupt service availability [[2]](#引用) . Mitigation involves ensuring that the XStream implementation adheres strictly to security best practices, including the use of a whitelist model for class loading and sanitizing input to prevent malicious data from being processed.

## 根因分析

 Root Cause Analysis of CVE-2021-21341

The vulnerability identified as CVE-2021-21341 in the XStream library arises from inadequate input validation in the `ImmutableTypesMapper` class, which can lead to denial-of-service (DoS) attacks by enabling an attacker to induce an infinite loop through crafted input [[5]](#引用) . The root cause consists of multiple interrelated issues that contribute to this vulnerability.

 Part 1: Lack of Input Validation

The core issue in the vulnerable code is the reliance on a blacklist approach for managing immutable types, which lacks sufficient validation against malicious or unexpected input formats [[2]](#引用) .


```java
public boolean isImmutableValueType(Class type) {
    if (immutableTypes.contains(type)) {
        return true;
    } else {
        return super.isImmutableValueType(type);
    }
}
```

In the above code snippet from `ImmutableTypesMapper.java`, the method `isImmutableValueType` determines if a given class type is immutable by checking if it exists in the `immutableTypes` set. However, if an attacker can manipulate input types to include non-validated classes or types, this function could allow unwanted behaviors (like infinite loops) through improper input handling [[5]](#引用) . Allowing unchecked types to access this method allows unwanted operations, potentially causing the program to enter an infinite loop [[1]](#引用) .

 Part 2: Insufficient Handling of Unreferenceable Types

Moreover, the method that checks if a type is referenceable also fails to correctly handle potential edge cases related to unreferenceable types:


```java
public boolean isReferenceable(final Class type) {
    if (unreferenceableTypes.contains(type)) {
        return false;
    } else {
        return super.isReferenceable(type);
    }
}
```

Here, `isReferenceable` checks if the provided `type` is in the `unreferenceableTypes` set, returning false if it is present, thereby preventing serialization. However, if a malicious input type is classified incorrectly (due to lack of precedent validation), it could lead to situations where legitimate types are improperly not referenceable [[2]](#引用) . This improper classification could cause a loop where the system continuously tries to validate these types, effectively leading to a DoS condition.

 Part 3: Over-reliance on Blacklist Mechanism 

The implementation's reliance on the blacklist methodology instead of a comprehensive whitelist approach to manage types is also a significant issue leading to the vulnerability [[2]](#引用) :


```java
private final Set unreferenceableTypes = new HashSet();
private final Set immutableTypes = new HashSet();
```

In the constructor, these sets are initialized to manage immutable and unreferenceable types. This design means the system trusts its contents without thoroughly validating the types being added. Such a design flaw can lead to types being manipulated to render the application vulnerable, as malicious input may disrupt expected behaviors without supervision [[2]](#引用) .

 Summary of Relationship

Each identified part of the root cause interconnects to strengthen the vulnerability. The lack of input validation enables untrusted types to be accepted, while inadequate classification of unreferenceable types allows for the possibility of infinite loops during serialization/deserialization processes [[5]](#引用) . Furthermore, dependence on a blacklist mechanism increases the risk of failures when facing unexpected attack vectors, as it doesn’t sufficiently restrict unauthorized types from being processed. Together, these factors create a scenario where crafted input can disrupt service stability ultimately resulting in denial-of-service conditions.

## 修复解释

In `ImmutableTypesMapper.java`, located in the `xstream/src/java/com/thoughtworks/xstream/mapper/` directory, several changes were made to mitigate the vulnerability CVE-2021-21341 by ensuring that enum types can no longer be processed as references during deserialization, thus adhering to a more secure whitelist approach.

The notable change can be observed in the `isReferenceable` method. The original implementation assessed whether types were unreferenceable, leading to potential exploitation via untrusted input:


```java
-        if (unreferenceableTypes.contains(type)) {
-            return false;
```

This section was modified to first check whether the class is an immutable type. The new logic allows a class to remain referenceable only if it's marked as immutable and not explicitly listed as unreferenceable:


```java
+        if (immutableTypes.contains(type)) {
+            return !unreferenceableTypes.contains(type);
```

This effectively prevents untrusted types from being deserialized, drastically tightening the security posture against remote code execution attacks that could arise from deserializing malicious input.

The commit ID associated with this patch is `15f2cd3364795eab785166f6f36f9a91e951373f`.The patch for the code is at: https://api.github.com/repos/x-stream/xstream/commits/15f2cd3364795eab785166f6f36f9a91e951373f

## 引用

- [1]  https://cert.360.cn/warning/detail?id=8c087e83dc7e64c8aa47fb9b964ee310
- [2]  https://www.debian.org/security/2021/dsa-5004
- [3]  https://www.secpulse.com/archives/155826.html
- [4]  https://www.anquanke.com/post/id/234653
- [5]  https://s.tencent.com/research/bsafe/1271.html
- [6]  http://markmail.org/message/q2iccuirqgekypdr?q=struts+list:org%2Eapache%2Estruts%2Edev

