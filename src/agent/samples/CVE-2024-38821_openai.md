## Description

CVE-2024-38821 is a critical vulnerability identified in Spring WebFlux applications, allowing for an authorization bypass under specific conditions [[3]](#References). The vulnerability arises when Spring Security authorization rules for static resources are improperly configured [[2]](#References)[[3]](#References). To be vulnerable, an application must meet three criteria: it must be a WebFlux application, it must utilize Spring's static resources support, and it must enforce a non-permitAll authorization rule on those static resources [[1]](#References)[[3]](#References). The severity of this issue is indicated by a CVSS base score of 9.1 [[3]](#References)[[6]](#References), where the attack vector is network-based with low attack complexity; no privileges or user interaction are required to exploit the vulnerability [[2]](#References)[[7]](#References). Importantly, while the confidentiality and integrity of the static resources are at high risk [[3]](#References)[[4]](#References), the availability of the application is unaffected [[7]](#References)[[8]](#References). The vulnerability is associated with CWEs such as CWE-285 (Improper Authorization) and CWE-770 (Allocation of Resources Without Limits or Throttling) [[1]](#References)[[11]](#References). The impacted components are primarily found within various versions of the Spring Security web package (org.springframework.security:spring-security-web) [[2]](#References). The ranges of affected versions include those introduced up to versions 6.3.0, which have since been fixed in subsequent releases [[2]](#References). Recommended mitigation steps include upgrading to secure versions: 5.7.13, 5.8.15, 6.0.13, 6.1.11, 6.2.7, or 6.3.4, to prevent potential exploitation [[2]](#References)[[11]](#References). This vulnerability does not affect platforms like Red Hat JBoss Enterprise Application Platform (EAP) as they do not utilize the Spring WebFlux or its static resources capabilities, thus eliminating the conditions for potential exploitation [[1]](#References)[[6]](#References).

## Affected Versions

- Component: Spring Security
    - Affected Versions: 0 through 5.7.12 (inclusive) [[9]](#References)
    - Affected Versions: 5.7.13 [[3]](#References)
    - Affected Versions: 5.8.0 through 5.8.14 (inclusive) [[2]](#References)
    - Affected Versions: 5.8.15 [[3]](#References)
    - Affected Versions: 6.0.0 through 6.0.12 (inclusive) [[2]](#References)
    - Affected Versions: 6.0.13 [[3]](#References)
    - Affected Versions: 6.1.0 through 6.1.10 (inclusive) [[2]](#References)
    - Affected Versions: 6.1.11 [[3]](#References)
    - Affected Versions: 6.2.0 through 6.2.6 (inclusive) [[2]](#References)
    - Affected Versions: 6.2.7 [[3]](#References)
    - Affected Versions: 6.3.0 through 6.3.3 (inclusive) [[2]](#References)
    - Affected Versions: 6.3.4 [[3]](#References)
- Component: Spring WebFlux
    - Affected Versions: Specific configurations that utilize Spring's static resources support with restricted (non-permitAll) authorization rules [[1]](#References)

## Unaffected Versions

- Component: org.springframework.security:spring-security-web
 .   - Unaffected Versions: 5.7.14 and later, 5.8.16 and later, 6.2.8 and later, 6.0.14 and later, 6.1.12 and later, 6.3.5 and later [[9]](#References)
- Component: Red Hat JBoss Enterprise Application Platform (EAP/XP)
    - Unaffected Versions: Not applicable; does not utilize Spring WebFlux or associated static resources functionality [[1]](#References)
- Component: Spring Security
    - Unaffected Versions: 5.7.13, 5.8.15, 6.0.13, 6.1.11, 6.2.7, 6.3.4 [[3]](#References)

## Mitigation

- Upgrade to fixed versions of Spring Security:
    - 5.7.13 [[9]](#References)
    - 5.8.15 [[9]](#References)
    - 6.0.13 [[9]](#References)
    - 6.1.11 [[9]](#References)
    - 6.2.7 (OSS) [[9]](#References)
    - 6.3.4 (OSS) [[9]](#References)

- Review and modify authorization rules for static resources:
    - Ensure no non-permitAll authorization rules are applied to static resources [[11]](#References).

- Confirm application is using an unaffected version of Spring Security for safety [[11]](#References).

## Exploit

CVE-2024-38821 is an authorization bypass vulnerability specifically affecting Spring WebFlux applications that implement non-permitAll authorization rules on static resources [[9]](#References). To successfully exploit this vulnerability, an attacker must ensure the following prerequisites are met:

1. The target application must be a Spring WebFlux application utilizing Spring Security for static resource protection [[1]](#References).
2. The application must support Spring's static resources, including assets like CSS, JavaScript, and images [[7]](#References).
3. The authorization rules for these static resources must explicitly restrict access by not using permitAll [[3]](#References). If all the above conditions are satisfied, an attacker can craft requests that bypass the intended security checks [[2]](#References). This can lead to unauthorized access to static resources that should be secured [[11]](#References).

The vulnerability has a low complexity rating for exploitation and does not require user privileges, enabling potential exploitation over the network [[10]](#References). Consequently, effective mitigation strategies should include applying updates to Spring Security that address this vulnerability [[8]](#References).

## Root Cause

The root cause of the authorization bypass vulnerability in the Spring WebFlux framework (CVE-2024-38821) stems primarily from improper handling of authorization rules related to static resources [[9]](#References). The framework's mechanism for applying security filters may incorrectly evaluate whether a request for static resources, such as CSS or JavaScript files, should be allowed based on the authorization constraints set by the application [[1]](#References). This leads to unauthorized access to restricted resources [[3]](#References).

One specific aspect contributing to this issue is how the framework processes HTTP requests against defined security chains without adequately applying the required authorization checks [[7]](#References). The relevant code from the vulnerable portion can be seen in the `filter` method of the `WebFilterChainProxy` class:

```java
@Override
public Mono<Void> filter(ServerWebExchange exchange, WebFilterChain chain) {
    return Flux.fromIterable(this.filters)
            .filterWhen((securityWebFilterChain) -> securityWebFilterChain.matches(exchange)).next()
            .switchIfEmpty(chain.filter(exchange).then(Mono.empty()))
            .flatMap((securityWebFilterChain) -> securityWebFilterChain.getWebFilters().collectList())
            .map((filters) -> new FilteringWebHandler(chain::filter, filters)).map(DefaultWebFilterChain::new)
            .flatMap((securedChain) -> securedChain.filter(exchange));
}
```

In this snippet, the invocation of the `matches` method on the `securityWebFilterChain` is pivotal. If the check does not return as expected or if the chain filter is executed without proper validation of the request's authorization, it could result in unauthorized access to static resources [[2]](#References).

Another contributing part to the vulnerability is the lack of a suitable mechanism to normalize incoming requests securely, potentially bypassing filter conditions [[11]](#References). The `isNormalized` method is critical, as it handles the validation of the request's path to ensure it cannot lead to unauthorized access:

```java
private boolean isNormalized(ServerHttpRequest request) {
    if (!isNormalized(request.getPath().value())) {
        return false;
    }
    if (!isNormalized(request.getURI().getRawPath())) {
        return false;
    }
    if (!isNormalized(request.getURI().getPath())) {
        return false;
    }
    return true;
}
```

The absence of strict enforcement around method paths, as indicated by this normalization check, may allow attackers to manipulate request paths or methods to successfully access protected resources without authorization [[10]](#References).

The consequence of these issues is significant; they undermine the framework's ability to secure static resources properly, thereby enabling unauthorized users to access sensitive information or functionality contained within those resources [[8]](#References).

## References

- [1] https://access.redhat.com/security/cve/cve-2024-38821
- [2] https://spring.io/security/cve-2024-38821
- [3] https://www.mend.io/vulnerability-database/CVE-2024-38821
- [4] https://cve.circl.lu/cve/CVE-2024-38821
- [5] https://www.deep-kondah.com/spring-webflux-static-resource-access-vulnerability-cve-2024-38821-explained/
- [6] https://github.com/spring-projects/spring-security
- [7] https://www.cvedetails.com/cve/CVE-2024-38821
- [8] https://nvd.nist.gov/vuln/detail/CVE-2024-38821
- [9] https://github.com/github/advisory-database/blob/main/advisories/github-reviewed/2024/10/GHSA-c4q5-6c82-3qpw/GHSA-c4q5-6c82-3qpw.json
- [10] https://app.soos.io/research/vulnerabilities/CVE-2024-38821
- [11] https://vulners.com/cve/CVE-2024-38821

