## 漏洞描述

Apache Commons Compress in Apache Software Foundation versions 1.11 to 1.15 is vulnerable to an infinite loop in the extra field parser of the ZipFile and ZipArchiveInputStream classes [[4]](#引用) . This vulnerability allows an attacker to execute a denial of service attack against services utilizing the Compress zip package via specially crafted ZIP archives [[5]](#引用) . The exploit occurs due to a loop with an unreachable exit condition triggered during the parsing of specially crafted ZIP files [[6]](#引用) .

## 详细描述

CVE-2018-1324 is a vulnerability in Apache Commons Compress that affects versions 1.11 through 1.15 [[4]](#引用) . This issue arises from a specially crafted ZIP archive that triggers an infinite loop within the extra field parser utilized by the ZipFile and ZipArchiveInputStream classes [[4]](#引用) [[5]](#引用) . The core problem is that the loop created in the parser has conditions that prevent it from terminating, thereby leading to a denial of service (DoS) situation for any service that employs the affected zip package [[1]](#引用) .

Exploitation of this vulnerability requires the attacker to generate a malformed ZIP file and present it to a service using the affected library, as it does not necessitate authentication or any specific privileges [[3]](#引用) . The denial of service effect can result in significant unavailability of services, impacting system operation, while confidentiality and integrity are not directly compromised [[6]](#引用) . It is categorized with a CVSS base score of 5.5, indicating a medium severity level [[6]](#引用) [[3]](#引用) . Effective mitigation requires upgrading to versions beyond 1.15 of Apache Commons Compress, where this issue has been resolved [[6]](#引用) .

## 排查步骤(生成式)

- Check for Apache Commons Compress: Verify if your installation uses the Apache Commons Compress library, which is the vulnerable package.
  
```bash
  mvn dependency:tree | grep commons-compress
```
  This command checks the project's dependencies to confirm whether the vulnerable library is included. A positive response establishes that you are potentially vulnerable.

- Check for affected versions: If Apache Commons Compress is used, check the version of the library. If the version is between 1.11 (inclusive) and 1.15 (inclusive), the installation is vulnerable. 
  
```bash
  mvn dependency:tree | grep commons-compress | awk '{print $2}' | cut -d':' -f2
```
  This command extracts the version of Apache Commons Compress used in your project. Finding a version in the specified range confirms potential vulnerability.

- Check for usage of ZipFile and ZipArchiveInputStream: Examine your code to confirm whether the vulnerable components, `ZipFile` and `ZipArchiveInputStream`, are being used in the project. 
  
```bash
  grep -r "ZipFile\|ZipArchiveInputStream" src/
```
  This command searches through the source code for occurrences of both classes. If found, this indicates the components are actively in use, raising the risk of exploitation.

- Check file upload functionality: Identify if any file upload mechanisms exist that could potentially process ZIP files using the vulnerable library.
  
```bash
  grep -rn "upload" src/
```
  This command searches for references to file upload functionality in your codebase. If identified, it indicates a potential pathway for an attacker to utilize crafted ZIP files to exploit the vulnerability.

## 受影响版本(生成式)

- Apache Commons Compress: Affected Versions: 1.11 to 1.15 (inclusive) [[5]](#引用) .

## 不受影响版本(生成式)

Apache Commons Compress Unaffected Versions:
- All versions prior to 1.11 [[4]](#引用) 
- Version 1.16 and later [[6]](#引用) 

List of Unaffected Packages:
- Apache Commons Compress: Versions < 1.11 [[2]](#引用)  and 1.16+ [[1]](#引用) 

## 规避方案(生成式)

1. Upgrade Library: Update Apache Commons Compress to version 1.16 or higher to resolve the infinite loop vulnerability present in versions 1.11 through 1.15 [[4]](#引用) .

   Implementation Steps:
   - Identify the build tool used in your project (e.g., Maven, Gradle).
   - If using Maven, update the `pom.xml` file to specify the new version:
     
```xml
     <dependency>
         <groupId>org.apache.commons</groupId>
         <artifactId>commons-compress</artifactId>
         <version>1.16</version>
     </dependency>
```
   - If using Gradle, update the `build.gradle` file:
     
```groovy
     dependencies {
         implementation 'org.apache.commons:commons-compress:1.16'
     }
```
   - After making changes, run the build command to fetch the updated library (e.g., `mvn clean install` for Maven or `gradle build` for Gradle).
   
   Rationale: This patch eliminates the vulnerability entirely by ensuring that the code no longer enters an infinite loop when processing ZIP files due to the fixed logic in the updated library version [[2]](#引用) .

2. Implement Input Validation: Before processing any ZIP archives, implement validation checks to verify the integrity and format of the ZIP files [[4]](#引用) .

   Implementation Steps:
   - Introduce a method to validate ZIP files, checking for known structures and ensuring they do not exceed expected limits:
     
```java
     public boolean isValidZipFile(File zipFile) {
         try (ZipFile zip = new ZipFile(zipFile)) {
             for (ZipEntry entry : zip.entries()) {
                 if (entry.getSize() < 0 || entry.getSize() > MAX_EXPECTED_SIZE) {
                     return false; // Or log an error
                 }
             }
         } catch (IOException e) {
             return false; // Handle errors accordingly
         }
         return true;
     }
```
   - Use this validation function before parsing or processing the ZIP archive:
     
```java
     File zipFile = new File("path/to/archive.zip");
     if (isValidZipFile(zipFile)) {
         // Process the ZIP file
     } else {
         // Handle invalid ZIP file scenario
     }
```

   Rationale: Implementing input validation checks helps in identifying potentially malicious ZIP files early in the processing stage, thereby preventing the application from entering an infinite loop and enabling further actions without processing flawed data [[6]](#引用) .

## 受影响版本(总结式)

- Component: Apache Commons Compress
    - Affected Versions: 1.11 to 1.15 (inclusive) [[5]](#引用) 

## 不受影响版本(总结式)

- Component: Apache Commons Compress
    - Unaffected Versions: 1.0, 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7, 1.8, 1.9, 1.10, 1.11, 1.16 and later [[6]](#引用) 
    - All versions before 1.11 [[4]](#引用) [[5]](#引用) [[1]](#引用) 
    - All versions after 1.15 [[4]](#引用) [[6]](#引用) 

## 排查步骤(总结式)

- Check the installation status of Apache Commons Compress to confirm it is properly installed in your environment [[4]](#引用) .
- Verify the version, ensuring it falls within the affected range of 1.11 to 1.15 [[5]](#引用) .
- Assess if your application processes ZIP archives with Apache Commons Compress, as this is where the vulnerability is triggered [[4]](#引用) [[6]](#引用) .
- Look for existing patches or updates, specifically for version 1.16, which resolves the vulnerability [[4]](#引用) [[6]](#引用) .

## 规避方案(总结式)

- Upgrade to Apache Commons Compress version 1.16 or higher [[4]](#引用) .
- Avoid using specially crafted ZIP archives that can exploit the vulnerability [[4]](#引用) .
- Implement validation checks on contents of ZIP archives [[4]](#引用) .
- Monitor applications using Apache Commons Compress for unusual behavior indicative of a denial of service attack [[4]](#引用) .
- Test the upgrade on non-production systems before full deployment [[3]](#引用) .

## 利用分析

CVE-2018-1324 is a vulnerability found in versions 1.11 to 1.15 of Apache Commons Compress, which involves a flaw in the extra field parser of the ZipFile and ZipArchiveInputStream classes [[4]](#引用) . The exploit begins with the attacker creating a specially crafted ZIP archive that is intentionally malformed to produce an infinite loop during extraction [[2]](#引用) . The steps to exploit this vulnerability include: 1. Crafting a Malformed ZIP Archive: The attacker designs a ZIP file that triggers the infinite loop upon processing by the vulnerable library [[6]](#引用) . 2. Delivering the ZIP Archive: The attacker must find a way to submit this ZIP file to the target service utilizing Apache Commons Compress. This could be through a file upload mechanism or other means of file delivery [[2]](#引用) . 3. Initiating Decompression: Once the target system receives the crafted ZIP file, the service attempts to decompress it using the affected classes [[4]](#引用) . 4. Inducing the Infinite Loop: During the decompression process, the input causes the parser to enter an infinite loop, ultimately leading to resource exhaustion on the target system [[1]](#引用) . This exploitation route effectively results in a denial of service, crippling the availability of the affected services [[5]](#引用) . The attack is relatively low in complexity but does require user interaction to trigger the processing of the ZIP file [[6]](#引用) .

## 根因分析

The vulnerability identified as CVE-2018-1324 in Apache Commons Compress is primarily attributed to an infinite loop in the `parseCentralDirectoryFormat` method of the `X0017_StrongEncryptionHeader` class [[4]](#引用) [[5]](#引用) . This infinite loop can be triggered by carefully crafted ZIP files, leading to a denial of service attack [[2]](#引用) . The root cause of the vulnerability involves several interconnected issues that form the basis for the infinite loop condition . The first part of the root cause is the inappropriate data type chosen for the variable `rcount` . It is defined as a `long` but used as an `int` in the loop condition . The line `for (int i = 0; i < this.rcount; i++)` utilizes `int` for the loop control . This is problematic because `rcount` can potentially hold values greater than `Integer.MAX_VALUE` (2,147,483,647) . The second part of the root cause is the absence of validation checks for the value of `rcount` . The code only checks if `rcount` is greater than zero, but it does not ensure it is within a reasonable range that can be safely processed . The third aspect of the vulnerability lies in the way the loop is structured without a proper upper limit check leveraging the potentially problematic `rcount` . Without proper type checks and validation for `rcount`, this for-loop can continue to run forever if the initial conditions are met . The combination of these interlinked issues demonstrates how design oversights can lead to significant security vulnerabilities .

## 修复解释

In the patch identified by commit ID `2a2f1dc48e22a34ddb72321a4db211da91aa933b`, a modification was made to the `parseCentralDirectoryFormat` method within the `X0017_StrongEncryptionHeader.java` file located at `src/main/java/org/apache/commons/compress/archivers/zip/`. 

The relevant code segment that was altered is as follows:


```java
-            for (int i = 0; i < this.rcount; i++) {
+            for (long i = 0; i < this.rcount; i++) {
```

This change involves modifying the loop index variable from `int i` to `long i`. By allowing `i` to be of type `long`, the code better accommodates the potentially large values of `rcount`, which represents the number of recipient entries. This is crucial because if `rcount` exceeds the maximum value that can be held by an `int`, it could lead to an infinite loop if the condition `i < this.rcount` is not appropriately evaluated. Therefore, this change helps to prevent situations where the loop could iterate indefinitely, thus resolving the denial of service vulnerability associated with CVE-2018-1324.The patch for the code is at: https://api.github.com/repos/apache/commons-compress/commits/2a2f1dc48e22a34ddb72321a4db211da91aa933b

## 引用

- [1]  https://nvd.nist.gov/vuln/detail/CVE-2018-1324
- [2]  https://vulners.com/cve/CVE-2018-1324
- [3]  https://s.tencent.com/research/report/158
- [4]  https://cve.circl.lu/cve/CVE-2018-1324
- [5]  https://www.cvedetails.com/cve/CVE-2018-1324
- [6]  https://app.soos.io/research/vulnerabilities/CVE-2018-1324

